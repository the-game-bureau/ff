<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Law & Order: Special Victory Unit</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="src/lawandorder.jpg"/>
  <link rel="apple-touch-icon" sizes="180x180" href="src/lawandorder.jpg"/>
  <link rel="icon" type="image/png" sizes="32x32" href="src/lawandorder.jpg"/>
  <link rel="icon" type="image/png" sizes="16x16" href="src/lawandorder.jpg"/>
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website"/>
  <meta property="og:url" content="https://lawandorder-svu.app/"/>
  <meta property="og:title" content="Law & Order: Special Victory Unit"/>
  <meta property="og:description" content="In the NFL justice system, the people are represented by two separate yet equally important groups: those who win, and those who lose. These are their stories."/>
  <meta property="og:image" content="src/lawandorder.jpg"/>
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image"/>
  <meta property="twitter:url" content="https://lawandorder-svu.app/"/>
  <meta property="twitter:title" content="Law & Order: Special Victory Unit"/>
  <meta property="twitter:description" content="In the NFL justice system, the people are represented by two separate yet equally important groups: those who win, and those who lose. These are their stories."/>
  <meta property="twitter:image" content="src/lawandorder.jpg"/>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
/* ===== SINGLE LOCAL HEADER FONT ===== */
@font-face {
  font-family: 'FrizQuadrataRegular';
  src: url('./fonts/FrizQuadrataRegular.woff') format('woff');
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

/* ===== COLOR SYSTEM ===== */
:root{
  --primary-red: #DC2626;
  --primary-red-dark: #B91C1C;
  --primary-blue: #1E40AF;
  --primary-blue-mid: #1D4ED8;
  
  --text-primary: #111827;
  --text-secondary: #374151;
  --text-tertiary: #6B7280;
  
  --bg-primary: #FFFFFF;
  --bg-secondary: #F9FAFB;
  --bg-tertiary: #F3F4F6;
  --bg-accent: #E5E7EB;
  --bg-hover: #F9FAFB;
  
  --success: #059669;
  --warning: #D97706;
  --error: #DC2626;
}

*{
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html{
  background: var(--bg-primary);
}

body{
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  font-size: 18px;
  line-height: 1.6;
  color: var(--text-primary);
  background: var(--bg-primary);
  min-height: 100vh;
  letter-spacing: 0;
}

/* ===== HEADER WITH LAW & ORDER LOGO ===== */
.header{
  background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
  padding: 24px 16px;
  text-align: center;
  border-bottom: 4px solid var(--primary-blue);
  border-radius: 0;
}

.header-logo{
  max-width: 100%;
  height: auto;
  max-height: 80px;
  margin-bottom: 16px;
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.header-logo-text{
  font-family: 'FrizQuadrataRegular', serif;
  font-weight: 900;
  margin-bottom: 16px;
  line-height: 1.0;
  text-transform: uppercase;
}

.law-text{
  font-size: 2.5rem;
  color: #FFFFFF;
  text-shadow: 
    0 0 5px #4169E1, 
    0 0 10px #4169E1, 
    0 0 20px #4169E1,
    0 0 30px #4169E1,
    2px 2px 4px rgba(0,0,0,0.8);
  display: block;
  letter-spacing: 0.15em;
  font-weight: 900;
  font-family: 'FrizQuadrataRegular', serif;
}

.ampersand{
  font-size: 2rem;
  color: #FFFFFF;
  text-shadow: 
    0 0 5px #4169E1, 
    0 0 10px #4169E1,
    2px 2px 4px rgba(0,0,0,0.8);
  margin: 0 0.3em;
  font-weight: 900;
  font-family: 'FrizQuadrataRegular', serif;
}

.order-text{
  font-size: 2.5rem;
  color: #FFFFFF;
  text-shadow: 
    0 0 5px #DC143C, 
    0 0 10px #DC143C, 
    0 0 20px #DC143C,
    0 0 30px #DC143C,
    2px 2px 4px rgba(0,0,0,0.8);
  display: block;
  letter-spacing: 0.15em;
  margin-top: 8px;
  font-weight: 900;
  font-family: 'FrizQuadrataRegular', serif;
}

.svu-subtitle{
  font-size: 1.2rem;
  color: #FFFFFF; 
  text-shadow: 
    0 0 3px #FFFFFF,
    0 0 8px #FFD700,
    0 0 15px #FFD700,
    0 0 25px #FFA500,
    0 0 35px #FF8C00,
    2px 2px 4px rgba(0,0,0,0.8);
  font-weight: 700;
  margin-bottom: 12px;
  letter-spacing: 0.1em;
  font-family: 'FrizQuadrataRegular', serif;
  text-transform: uppercase;
}

.header h1{
  display: none;
}

.tagline{
  font-size: 0.9rem;
  font-weight: 400;
  color: rgba(255, 255, 255, 0.95);
  font-style: italic;
  max-width: 100%;
  margin: 0 auto;
  line-height: 1.5;
  padding: 0 8px;
}

.container{
  max-width: 1200px;
  margin: 0 auto;
  padding: 16px;
}

/* ===== AUTHENTICATION ===== */
#authBar{
  display: flex;
  gap: 12px;
  align-items: stretch;
  justify-content: center;
  margin: 20px 0;
  flex-wrap: wrap;
}

#authBar input{
  padding: 16px;
  border: 2px solid var(--bg-accent);
  border-radius: 8px;
  font-size: 16px;
  font-family: inherit;
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 44px;
  min-width: 200px;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

#authBar input:focus{
  outline: none;
  border-color: var(--primary-blue);
  box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
}

#authBar input::placeholder{
  color: var(--text-tertiary);
}

/* ===== BUTTONS ===== */
.btn{
  padding: 16px 24px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  font-size: 16px;
  text-transform: uppercase;
  letter-spacing: 0.025em;
  cursor: pointer;
  font-family: inherit;
  min-height: 44px;
  transition: all 0.2s ease;
  -webkit-tap-highlight-color: transparent;
}

.btn-primary{
  background: var(--primary-red);
  color: white;
  border: 2px solid var(--primary-red);
}

.btn-primary:hover, .btn-primary:focus{
  background: var(--primary-red-dark);
  border-color: var(--primary-red-dark);
  transform: translateY(-1px);
}

.btn-secondary{
  background: var(--primary-blue);
  color: white;
  border: 2px solid var(--primary-blue);
}

.btn-secondary:hover, .btn-secondary:focus{
  background: var(--primary-blue-mid);
  border-color: var(--primary-blue-mid);
  transform: translateY(-1px);
}

.btn:disabled{
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
  background: var(--bg-accent);
  color: var(--text-tertiary);
  border-color: var(--bg-accent);
}

/* ===== USERNAME GATE ===== */
#usernameGate{
  display: none;
  max-width: 400px;
  margin: 20px auto;
  border: 3px solid var(--primary-blue);
  border-radius: 12px;
  padding: 24px;
  background: var(--bg-primary);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
}

#usernameGate h3{
  font-weight: 700;
  font-size: 1.125rem;
  color: var(--primary-blue);
  margin-bottom: 12px;
  text-transform: uppercase;
  letter-spacing: 0.02em;
}

#usernameGate input{
  padding: 16px;
  border: 2px solid var(--bg-accent);
  border-radius: 8px;
  width: 100%;
  margin-bottom: 16px;
  font-family: inherit;
  font-size: 16px;
  background: var(--bg-primary);
  color: var(--text-primary);
}

#usernameGate input:focus{
  outline: none;
  border-color: var(--primary-blue);
  box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
}

/* ===== CARDS ===== */
.game-info,
.team-selection,
.game-over,
.used-teams{
  background: var(--bg-primary);
  border: 3px solid var(--primary-blue);
  border-radius: 12px;
  padding: 20px;
  margin: 20px 0;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.game-info{
  border-color: var(--primary-red);
}

.used-teams{
  border-color: var(--text-tertiary);
  background: var(--bg-secondary);
}

.game-info h2,
.team-selection h2,
.game-over h2,
.used-teams h3{
  font-weight: 700;
  font-size: 1.25rem;
  color: var(--primary-blue);
  margin-bottom: 16px;
  text-transform: uppercase;
  letter-spacing: 0.025em;
  line-height: 1.3;
}

/* ===== VERDICT ===== */
.verdict{
  background: var(--bg-secondary);
  border-left: 4px solid var(--primary-blue);
  border-radius: 8px;
  padding: 16px;
  margin: 16px 0;
  font-style: normal;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* ===== STATUS BAR ===== */
.status-bar{
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  margin: 20px 0;
}

.status-card{
  background: var(--bg-primary);
  padding: 16px;
  text-align: center;
  border: 2px solid var(--bg-accent);
  border-radius: 12px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.status-card h3{
  font-weight: 600;
  font-size: 0.75rem;
  color: var(--text-tertiary);
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  line-height: 1.2;
}

.status-card .value{
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--primary-red);
  line-height: 1.1;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
}

#playerName{
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  display: block;
  font-size: 1.25rem !important;
}

/* ===== TEAM GRID ===== */
.team-grid{
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
  margin-top: 20px;
}

.team-card{
  background: var(--bg-primary);
  color: var(--text-primary);
  border: 2px solid var(--team-secondary, var(--bg-accent));
  border-left: 6px solid transparent;
  border-radius: 12px;
  padding: 20px 16px;
  text-align: left;
  transition: all 0.2s ease;
  cursor: pointer;
  min-height: 60px;
  display: flex;
  align-items: center;
  justify-content: flex-start;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.team-card:hover{
  background: var(--bg-hover);
  border: 2px solid var(--primary-blue);
  border-left: 6px solid var(--team-primary, #4B5563);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.team-card.selected{
  background: rgba(30, 64, 175, 0.05);
  border: 2px solid var(--primary-blue);
  border-right: 4px solid var(--primary-blue);
  border-left: 6px solid var(--team-primary, #4B5563);
}

.team-card.disabled{
  opacity: 0.6;
  cursor: not-allowed;
  background: var(--bg-secondary);
  color: var(--text-tertiary);
}

.team-card.disabled:hover{
  transform: none;
  background: var(--bg-secondary);
  border: 2px solid var(--team-secondary, var(--bg-accent));
  border-left: 6px solid var(--team-primary, #4B5563);
}

.team-name{
  font-weight: 600;
  font-size: 1rem;
  line-height: 1.4;
  color: inherit;
}

/* ===== ACTION BUTTONS ===== */
.action-buttons{
  display: flex;
  gap: 12px;
  justify-content: center;
  margin: 24px 0;
  flex-direction: column;
}

.action-buttons .btn{
  width: 100%;
}

/* ===== USED TEAMS ===== */
.used-list{
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.used-team{
  background: var(--bg-secondary);
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--text-primary);
  line-height: 1.3;
  border: 2px solid var(--bg-accent);
}

/* ===== TABLES ===== */
table{
  font-size: 0.875rem;
  width: 100%;
  border-collapse: collapse;
  line-height: 1.4;
  background: var(--bg-primary);
}

th{
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.02em;
  color: var(--text-primary);
  background: var(--bg-secondary);
  font-size: 0.75rem;
}

th, td{
  padding: 12px 8px;
  text-align: left;
  vertical-align: top;
  border-bottom: 1px solid var(--bg-accent);
}

/* ===== STATUS LABELS ===== */
.status-label{
  display: inline-block;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.02em;
  color: white;
}

.status-active{
  background: var(--success);
}

.status-eliminated{
  background: var(--error);
}

.status-other{
  background: var(--text-tertiary);
}

/* ===== FOOTER ===== */
.footer{
  border-top: 2px solid var(--bg-accent);
  text-align: center;
  color: var(--text-tertiary);
  padding: 20px 16px;
  margin-top: 32px;
  font-size: 0.875rem;
  line-height: 1.5;
}

/* ===== RESPONSIVE ===== */
@media (min-width: 480px){
  .container{ padding: 20px; }
  .law-text, .order-text{ font-size: 3rem; }
  .ampersand{ font-size: 2.5rem; }
  .svu-subtitle{ font-size: 1.4rem; }
  .tagline{ font-size: 1rem; }
  .team-grid{ grid-template-columns: repeat(2, 1fr); gap: 16px; }
}

@media (min-width: 768px){
  .container{ padding: 24px; }
  .law-text, .order-text{ font-size: 3.5rem; }
  .ampersand{ font-size: 3rem; }
  .svu-subtitle{ font-size: 1.6rem; }
  .status-bar{ grid-template-columns: repeat(2, 1fr); }
  .team-grid{ grid-template-columns: repeat(3, 1fr); }
  .action-buttons{ flex-direction: row; }
  .btn{ width: auto; }
}

@media (min-width: 1024px){
  body{ font-size: 16px; }
  .header{ padding: 32px 24px; }
  .law-text, .order-text{ font-size: 4rem; }
  .ampersand{ font-size: 3.5rem; }
  .svu-subtitle{ font-size: 1.8rem; }
  .status-bar{ grid-template-columns: repeat(4, 1fr); }
  .team-grid{ grid-template-columns: repeat(4, 1fr); gap: 20px; }
  .team-card{ text-align: center; justify-content: center; }
  .status-card .value{ font-size: 2rem; }
  #playerName{ font-size: 1.75rem !important; }
}

/* ===== UTILITY ===== */
.sr-only{
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

@keyframes slideIn{
  from{ opacity: 0; transform: translateY(20px); }
  to{ opacity: 1; transform: translateY(0); }
}

.slide-in{ animation: slideIn 0.3s ease-out; }
</style>
</head>

<body>
  <header class="header" role="banner">
    <div class="header-logo-text">
      <div class="law-text">LAW<span class="ampersand">&</span></div>
      <div class="order-text">ORDER</div>
    </div>
    <div class="svu-subtitle">Special Victory Unit</div>
    <h1>Law & Order: Special Victory Unit</h1>
    <p class="tagline">"In the NFL justice system, the people are represented by two separate yet equally important groups: those who win, and those who lose. These are their stories. Dun Dun."</p>
  </header>

  <div class="container">
    <div id="authBar" role="complementary" aria-label="User authentication">
      <div id="authWhenLoggedOut" style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;">
        <input id="authEmail" type="email" placeholder="Email" aria-label="Email address" />
        <input id="authPass" type="password" placeholder="Password" aria-label="Password" />
        <button id="btnSignUp" class="btn btn-secondary" type="button">Sign Up</button>
        <button id="btnSignIn" class="btn btn-secondary" type="button">Sign In</button>
        <button id="btnResetPassword" class="btn btn-secondary" type="button">Reset Password</button>
        <p style="width:100%;text-align:center;">If you've played before you still have to sign up.</p>
      </div>

      <div id="authWhenLoggedIn" style="display:none;gap:8px;align-items:center;flex-wrap:wrap;">
        <span id="displayUser" style="font-weight:600;color:var(--primary-blue)" aria-label="Current user"></span>
        <button id="btnSignOut" class="btn btn-secondary" type="button">Sign Out</button>
      </div>
    </div>

    <div id="usernameGate" role="dialog" aria-labelledby="usernameGateTitle" aria-hidden="true">
      <h3 id="usernameGateTitle">Choose a Username</h3>
      <p style="margin-bottom:16px;color:var(--text-secondary);line-height:1.4">Pick a public handle for the game (3‚Äì20 letters/numbers/underscore). Cannot be changed later.</p>
      <input id="usernameInput" type="text" placeholder="Username" aria-label="Username" style="padding:12px;border:2px solid var(--bg-accent);width:100%;margin-bottom:16px;font-family:inherit;"/>
      <button id="btnSaveUsername" class="btn btn-primary" type="button">Save Username</button>
      <div id="usernameError" role="alert" style="color:var(--error);margin-top:12px;font-weight:600"></div>
    </div>

    <section class="game-info" aria-labelledby="gameInfoTitle">
      <h2 id="gameInfoTitle">üèõÔ∏è The Case File</h2>
      <p><strong>The Rules:</strong> Each week, you must select one NFL team that you believe will <em>lose</em> their game. If your selected team loses, you advance. If they win or tie, you're out. You can use each team only once per season. No draft, no grand jury necessary.</p>

      <div class="verdict" role="note">
        <strong>Detective Briscoe:</strong> "We're betting on losers? Easy! I pick losers at the track every weekend."
      </div>
    </section>

    <section class="status-bar" aria-label="Game status overview">
      <div class="status-card">
        <h3>Player</h3>
        <div class="value" id="playerName" aria-live="polite">Detective</div>
      </div>
      <div class="status-card">
        <h3>Current Week</h3>
        <div class="value" id="currentWeek" aria-live="polite">1</div>
      </div>
      <div class="status-card">
        <h3>NFL Teams Used</h3>
        <div class="value" id="teamsUsedCount" aria-live="polite">0</div>
      </div>
      <div class="status-card">
        <h3>NFL Teams Remaining</h3>
        <div class="value" id="teamsRemaining" aria-live="polite">32</div>
      </div>
    </section>

    <section class="team-selection" id="teamSelection" aria-labelledby="teamSelectionTitle">
      <h2 id="teamSelectionTitle">üèà Suspect Lineup</h2>
      <p>(A team you believe will lose this week):</p>
      
      <div class="team-grid" id="teamGrid" role="group" aria-label="NFL teams pick"></div>
      
      <div id="alreadyPickedMsg" 
           role="alert" 
           aria-live="polite"
           style="margin-top:16px;color:var(--primary-blue);font-weight:600;display:none;"></div>
    </section>

    <section class="action-buttons" role="group" aria-label="Game actions">
      <button class="btn btn-secondary" id="viewSchedule" aria-describedby="viewScheduleHelp">
        View NFL Schedule
      </button>
      <button class="btn btn-primary" id="submitPick" disabled aria-describedby="submitPickHelp">
        Submit Your Suspect
      </button>
      <button class="btn btn-secondary" id="newGame" aria-describedby="newGameHelp">
        Reset Pick
      </button>
      
      <div class="sr-only">
        <div id="submitPickHelp">Submit your team pick for this week</div>
        <div id="viewScheduleHelp">View the 2025 NFL schedule in a new tab</div>
        <div id="newGameHelp">Reset the game interface</div>
      </div>
    </section>

    <section class="used-teams" id="usedTeamsSection" style="display:none;" aria-labelledby="usedTeamsTitle">
      <h3 id="usedTeamsTitle">‚öñÔ∏è Judgements Rendered (Your Picks)</h3>
      <div class="used-list" id="usedTeamsList" role="list" aria-label="Teams you have already picked"></div>
    </section>

    <section class="game-over" id="gameOverSection" style="display:none;" aria-labelledby="gameOverTitle">
      <h2 id="gameOverTitle">‚öñÔ∏è CASE CLOSED</h2>
      <p id="gameOverMessage" role="status"></p>
      <div class="verdict" id="finalVerdict" role="note"></div>
    </section>

    <section class="game-info" id="leagueStats" aria-labelledby="leagueStatsTitle">
<h3 style="margin:24px 0 16px;font-weight:700;color:var(--primary-blue);text-transform:uppercase;">
  üîê Evidence Locker
</h3>

<div id="statsSummary" 
     style="margin:16px 0 24px;color:var(--primary-blue);font-weight:600"
     aria-live="polite"></div>

<div style="overflow:auto;border:2px solid var(--primary-blue);background:var(--bg-primary);margin-bottom:24px">
  <table id="userSummaryTable" role="table" aria-label="User summary statistics">
    <caption class="sr-only">Summary of all users' picks and activity</caption>
    <thead>
      <tr>
        <th scope="col">User</th>
        <th scope="col">Status</th>
        <th scope="col">Weeks Picked</th>
        <th scope="col">Teams Used</th>
        <th scope="col">Last Pick (Week)</th>
      </tr>
    </thead>
    <tbody id="userSummaryBody"></tbody>
  </table>
</div>

<h3 style="margin:24px 0 16px;font-weight:700;color:var(--primary-blue);text-transform:uppercase;">
  üîé Evidence Log: Latest Filings
</h3>
<div style="overflow:auto;border:2px solid var(--primary-blue);background:var(--bg-primary)">
  <table id="allPicksTable" role="table" aria-label="All user picks chronologically">
    <caption class="sr-only">Complete chronological list of all picks made by all users</caption>
    <thead>
      <tr>
        <th scope="col">Week</th>
        <th scope="col">User</th>
        <th scope="col">Team</th>
        <th scope="col">Picked At</th>
      </tr>
    </thead>
    <tbody id="allPicksBody"></tbody>
  </table>
</div>
    </section>

  </div>

  <footer class="footer" role="contentinfo">
    <p>Executive Producer: Dick Wolf ¬∑ "These stories are fictional. Any resemblance to actual fantasy football leagues is purely coincidental."</p>
  </footer>

  <script>
    const SUPABASE_URL = 'https://jdyjyzakcfmvwdfgzzyz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkeWp5emFrY2ZtdndkZmd6enl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyNjAxNDQsImV4cCI6MjA3MTgzNjE0NH0.8gQ5Xg0HhZBI61i6XS-kK9Ui-3DxRywXT40OB9YNIbI';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const nflTeams = [
      { name: "Arizona Cardinals",    primary: "#97233F", secondary: "#FFB612" },
      { name: "Atlanta Falcons",      primary: "#A71930", secondary: "#000000" },
      { name: "Baltimore Ravens",     primary: "#241773", secondary: "#9E7C0C" },
      { name: "Buffalo Bills",        primary: "#00338D", secondary: "#C60C30" },
      { name: "Carolina Panthers",    primary: "#0085CA", secondary: "#BFC0BF" },
      { name: "Chicago Bears",        primary: "#0B162A", secondary: "#C83803" },
      { name: "Cincinnati Bengals",   primary: "#FB4F14", secondary: "#000000" },
      { name: "Cleveland Browns",     primary: "#311D00", secondary: "#FF3C00" },
      { name: "Dallas Cowboys",       primary: "#003594", secondary: "#869397" },
      { name: "Denver Broncos",       primary: "#FB4F14", secondary: "#002244" },
      { name: "Detroit Lions",        primary: "#0076B6", secondary: "#B0B7BC" },
      { name: "Green Bay Packers",    primary: "#203731", secondary: "#FFB612" },
      { name: "Houston Texans",       primary: "#03202F", secondary: "#A71930" },
      { name: "Indianapolis Colts",   primary: "#002C5F", secondary: "#A5ACAF" },
      { name: "Jacksonville Jaguars", primary: "#101820", secondary: "#D7A22A" },
      { name: "Kansas City Chiefs",   primary: "#E31837", secondary: "#FFB81C" },
      { name: "Las Vegas Raiders",    primary: "#000000", secondary: "#A5ACAF" },
      { name: "Los Angeles Chargers", primary: "#0080C6", secondary: "#FFC20E" },
      { name: "Los Angeles Rams",     primary: "#003594", secondary: "#FFA300" },
      { name: "Miami Dolphins",       primary: "#008E97", secondary: "#FC4C02" },
      { name: "Minnesota Vikings",    primary: "#4F2683", secondary: "#FFC62F" },
      { name: "New England Patriots", primary: "#002244", secondary: "#C60C30" },
      { name: "New Orleans Saints",   primary: "#101820", secondary: "#D3BC8D" },
      { name: "New York Giants",      primary: "#0B2265", secondary: "#A71930" },
      { name: "New York Jets",        primary: "#125740", secondary: "#FFFFFF" },
      { name: "Philadelphia Eagles",  primary: "#004C54", secondary: "#A5ACAF" },
      { name: "Pittsburgh Steelers",  primary: "#FFB612", secondary: "#101820" },
      { name: "San Francisco 49ers",  primary: "#AA0000", secondary: "#B3995D" },
      { name: "Seattle Seahawks",     primary: "#002244", secondary: "#69BE28" },
      { name: "Tampa Bay Buccaneers", primary: "#D50A0A", secondary: "#FF7900" },
      { name: "Tennessee Titans",     primary: "#0C2340", secondary: "#4B92DB" },
      { name: "Washington Commanders",primary: "#5A1414", secondary: "#FFB612" }
    ];

    let gameState = {
      currentWeek: 1, // Will be loaded from database
      usedTeams: [],
      selectedTeam: null,
      isActive: true,
      weeklyPicks: [],
      lastWeekAdvancement: 0
    };

    let currentUser = null;
    let currentProfile = null;

    function getCentralNow(){
      const now = new Date();
      return new Date(now.toLocaleString("en-US", { timeZone: "America/Chicago" }));
    }

    // Database-based week management functions
    async function getCurrentWeekFromDB() {
      try {
        const { data, error } = await supabase
          .from('game_settings')
          .select('current_week, last_updated')
          .eq('id', 1)
          .maybeSingle();

        if (error && error.code !== 'PGRST116') {
          console.error('Error fetching current week:', error);
          return 1;
        }

        if (!data) {
          // Initialize the game settings table
          const { data: newData, error: insertError } = await supabase
            .from('game_settings')
            .insert({ id: 1, current_week: 1, last_updated: new Date().toISOString() })
            .select()
            .single();
          
          if (insertError) {
            console.error('Error initializing game settings:', insertError);
            return 1;
          }
          
          return newData?.current_week || 1;
        }

        return data.current_week || 1;
      } catch (error) {
        console.error('Unexpected error fetching current week:', error);
        return 1;
      }
    }

    async function advanceWeekInDB() {
      try {
        const { data, error } = await supabase
          .from('game_settings')
          .update({ 
            current_week: gameState.currentWeek + 1,
            last_updated: new Date().toISOString()
          })
          .eq('id', 1)
          .select()
          .single();

        if (error) {
          console.error('Error advancing week:', error);
          return false;
        }

        gameState.currentWeek = data.current_week;
        return true;
      } catch (error) {
        console.error('Unexpected error advancing week:', error);
        return false;
      }
    }

    function autoFitPlayerName(minPx = 12, maxPx = 28, padPx = 8){
      const el = document.getElementById('playerName');
      if(!el) return;
      
      const container = el.parentElement;
      el.style.fontSize = maxPx + 'px';
      
      let size = maxPx;
      let loops = 40;
      
      while(size > minPx && el.scrollWidth > (container.clientWidth - padPx)){
        size--;
        el.style.fontSize = size + 'px';
        if(--loops <= 0) break;
      }
    }

    async function refreshAuthUI(){
      try {
        const { data: { user } } = await supabase.auth.getUser();
        currentUser = user || null;

        const loggedOutEl = document.getElementById('authWhenLoggedOut');
        const loggedInEl = document.getElementById('authWhenLoggedIn');
        const usernameGateEl = document.getElementById('usernameGate');
        const displayUserEl = document.getElementById('displayUser');
        const submitPickEl = document.getElementById('submitPick');

        if(!currentUser){
          loggedOutEl.style.display = 'flex';
          loggedInEl.style.display = 'none';
          usernameGateEl.style.display = 'none';
          displayUserEl.textContent = '';
          
          if (submitPickEl) {
            submitPickEl.disabled = true;
          } else {
            console.warn('Element with ID "submitPick" not found in DOM');
          }
          document.getElementById('playerName').textContent = 'Detective';
          updateStatus();
          autoFitPlayerName();
          return;
        }

        loggedOutEl.style.display = 'none';
        loggedInEl.style.display = 'flex';

        const { data: profile, error } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', currentUser.id)
          .maybeSingle();

        if(error && error.code !== 'PGRST116') {
          console.error('Profile fetch error:', error);
          return;
        }

        if(!profile){
          usernameGateEl.style.display = 'block';
          usernameGateEl.setAttribute('aria-hidden', 'false');
          currentProfile = null;
          displayUserEl.textContent = '(set username)';
          document.getElementById('playerName').textContent = 'Detective';
          updateStatus();
          autoFitPlayerName();
        }else{
          usernameGateEl.style.display = 'none';
          usernameGateEl.setAttribute('aria-hidden', 'true');
          currentProfile = profile;
          displayUserEl.textContent = '@' + profile.username;
          document.getElementById('playerName').textContent = '@' + profile.username;
          autoFitPlayerName();
          
          await loadUserPicksAndDisableTeams();
        }
      } catch(error) {
        console.error('Auth refresh error:', error);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const btnSignUpEl = document.getElementById('btnSignUp');
      const btnSignInEl = document.getElementById('btnSignIn');
      const btnSignOutEl = document.getElementById('btnSignOut');
      const btnResetPasswordEl = document.getElementById('btnResetPassword');
      const btnSaveUsernameEl = document.getElementById('btnSaveUsername');
      const submitPickEl = document.getElementById('submitPick');
      const newGameEl = document.getElementById('newGame');
      const viewScheduleEl = document.getElementById('viewSchedule');

      if (btnSignUpEl) {
        btnSignUpEl.addEventListener('click', async () => {
          const email = document.getElementById('authEmail').value.trim();
          const password = document.getElementById('authPass').value;
          
          if(!email || !password) {
            alert('Please enter both email and password.');
            return;
          }

          try {
            const { data, error } = await supabase.auth.signUp({ 
              email, 
              password 
            });
            
            if(error) {
              alert('Sign up error: ' + error.message);
            } else {
              alert('You are signed up! Choose a username below to get started.');
            }
          } catch(error) {
            console.error('Signup error:', error);
            alert('An unexpected error occurred during signup.');
          }
        });
      } else {
        console.warn('Element with ID "btnSignUp" not found in DOM');
      }

      if (btnSignInEl) {
        btnSignInEl.addEventListener('click', async () => {
          const email = document.getElementById('authEmail').value.trim();
          const password = document.getElementById('authPass').value;
          
          if(!email || !password) {
            alert('Please enter both email and password.');
            return;
          }

          try {
            const { data, error } = await supabase.auth.signInWithPassword({ 
              email, 
              password 
            });
            
            if(error) {
              alert('Sign in error: ' + error.message);
            } else {
              await refreshAuthUI();
            }
          } catch(error) {
            console.error('Signin error:', error);
            alert('An unexpected error occurred during sign in.');
          }
        });
      } else {
        console.warn('Element with ID "btnSignIn" not found in DOM');
      }

      if (btnResetPasswordEl) {
        btnResetPasswordEl.addEventListener('click', async () => {
          const email = document.getElementById('authEmail').value.trim();
          
          if(!email) {
            alert('Please enter your email address first.');
            return;
          }

          try {
            const { error } = await supabase.auth.resetPasswordForEmail(email, {
              redirectTo: 'https://the-game-bureau.github.io/ff/index.html',
            });
            
            if(error) {
              alert('Password reset error: ' + error.message);
            } else {
              alert('Password reset email sent! Check your inbox and follow the instructions.');
            }
          } catch(error) {
            console.error('Password reset error:', error);
            alert('An unexpected error occurred during password reset.');
          }
        });
      } else {
        console.warn('Element with ID "btnResetPassword" not found in DOM');
      }

      if (btnSignOutEl) {
        btnSignOutEl.addEventListener('click', async () => {
          try {
            await supabase.auth.signOut();
            gameState.selectedTeam = null;
            await refreshAuthUI();
            renderTeams();
            updateStatus();
            updateUsedTeams();
          } catch(error) {
            console.error('Signout error:', error);
          }
        });
      } else {
        console.warn('Element with ID "btnSignOut" not found in DOM');
      }

      if (btnSaveUsernameEl) {
        btnSaveUsernameEl.addEventListener('click', async () => {
          const username = document.getElementById('usernameInput').value.trim();
          const errorEl = document.getElementById('usernameError');
          
          errorEl.textContent = '';

          if(!username || !/^[a-zA-Z0-9_]{3,20}$/.test(username)){
            errorEl.textContent = 'Your publicly visible username must be 3‚Äì20 characters, letters/numbers/underscore only.';
            return;
          }

          const email = currentUser?.email || null;

          try {
            const { error } = await supabase
              .from('profiles')
              .insert({ 
                id: currentUser.id, 
                username: username, 
                email: email 
              });

            if(error){
              if(error.code === '23505') {
                errorEl.textContent = 'That username is already taken.';
              } else {
                errorEl.textContent = 'Error creating profile: ' + error.message;
              }
              return;
            }

            document.getElementById('usernameGate').style.display = 'none';
            document.getElementById('usernameGate').setAttribute('aria-hidden', 'true');
            await refreshAuthUI();
            
          } catch(error) {
            console.error('Username save error:', error);
            errorEl.textContent = 'An unexpected error occurred.';
          }
        });
      } else {
        console.warn('Element with ID "btnSaveUsername" not found in DOM');
      }

      if (submitPickEl) {
        submitPickEl.addEventListener('click', submitPick);
      } else {
        console.warn('Element with ID "submitPick" not found in DOM');
      }

      if (newGameEl) {
        newGameEl.addEventListener('click', newGame);
      } else {
        console.warn('Element with ID "newGame" not found in DOM');
      }

      if (viewScheduleEl) {
        viewScheduleEl.addEventListener('click', () => {
          window.open('https://plaintextsports.com/nfl/2025/schedule', '_blank');
        });
      } else {
        console.warn('Element with ID "viewSchedule" not found in DOM');
      }

      window.addEventListener('resize', autoFitPlayerName);

      document.addEventListener('keydown', (e) => {
        if(e.key === 'Escape') {
          const usernameGate = document.getElementById('usernameGate');
          if(usernameGate.style.display === 'block') {
            usernameGate.style.display = 'none';
            usernameGate.setAttribute('aria-hidden', 'true');
          }
        }
        
        if(e.target.id === 'usernameInput' && e.key === 'Enter') {
          if (btnSaveUsernameEl) {
            btnSaveUsernameEl.click();
          }
        }
        
        if((e.target.id === 'authEmail' || e.target.id === 'authPass') && e.key === 'Enter') {
          if (btnSignInEl) {
            btnSignInEl.click();
          }
        }
      });

      // Modified initialization
      (async function initializeApplication(){
        console.log('Law & Order: Special Victory Unit - Initializing...');
        
        try {
          // Check for password reset flow first
          await handlePasswordResetFlow();
          
          // Load current week from database first
          gameState.currentWeek = await getCurrentWeekFromDB();
          console.log(`Current week loaded from database: ${gameState.currentWeek}`);
          
          renderTeams();
          updateStatus();
          updateUsedTeams();
          
          await refreshAuthUI();
          await refreshLeagueStats();
          
          // Check for week advancement every 5 minutes instead of every minute
          setInterval(checkWeekAdvancement, 300000);
          
          console.log(`Application initialized successfully - Week ${gameState.currentWeek}`);
          
        } catch(error) {
          console.error('Application initialization failed:', error);
        }
      })();
    });

    // Helper function to check if we're in password reset mode
    function isPasswordResetMode() {
      const urlHash = window.location.hash;
      return urlHash.includes('type=recovery') || urlHash.includes('access_token');
    }

    // Handle password reset flow
    async function handlePasswordResetFlow() {
      // Check if this is a password reset redirect
      if (isPasswordResetMode()) {
        console.log('Password reset flow detected');
        
        // Hide all other auth forms and show password reset form
        document.getElementById('authWhenLoggedOut').style.display = 'none';
        document.getElementById('authWhenLoggedIn').style.display = 'none';
        document.getElementById('usernameGate').style.display = 'none';
        document.getElementById('passwordResetForm').style.display = 'block';
        
        return true;
      }
      
      return false;
    }

    supabase.auth.onAuthStateChange((event, session) => {
      console.log('Auth state changed:', event);
      
      // Handle password recovery specifically
      if (event === 'PASSWORD_RECOVERY' || isPasswordResetMode()) {
        console.log('Password recovery event detected');
        document.getElementById('authWhenLoggedOut').style.display = 'none';
        document.getElementById('authWhenLoggedIn').style.display = 'none';
        document.getElementById('usernameGate').style.display = 'none';
        document.getElementById('passwordResetForm').style.display = 'block';
        return;
      }
      
      refreshAuthUI();
    });

    async function loadUserPicksAndDisableTeams(){
      if(!currentUser) return;

      try {
        const { data: picks, error } = await supabase
          .from('picks')
          .select('week, team')
          .eq('user_id', currentUser.id)
          .order('week', { ascending: true });

        if(error) {
          console.error('Error loading picks:', error);
          return;
        }

        gameState.usedTeams = picks.map(p => p.team);
        gameState.weeklyPicks = picks.slice();

        const currentWeekPick = picks.find(p => p.week === gameState.currentWeek);
        const alreadyPickedEl = document.getElementById('alreadyPickedMsg');
        const submitPickEl = document.getElementById('submitPick');

        if(currentWeekPick && alreadyPickedEl && submitPickEl) {
          submitPickEl.disabled = true;
          alreadyPickedEl.style.display = 'block';
          alreadyPickedEl.textContent = `Week ${currentWeekPick.week} you picked: ${currentWeekPick.team}.`;
        } else {
          if (alreadyPickedEl) alreadyPickedEl.style.display = 'none';
          if (!alreadyPickedEl) console.warn('Element with ID "alreadyPickedMsg" not found in DOM');
          if (!submitPickEl) console.warn('Element with ID "submitPick" not found in DOM');
        }

        renderTeams();
        updateStatus();
        renderUsedPicks(picks);

      } catch(error) {
        console.error('Unexpected error loading picks:', error);
      }
    }

    async function submitPick(){
      if(!currentUser) {
        alert('Please sign in first, detective.');
        return;
      }
      
      if(!currentProfile) {
        alert('Please choose a username to play.');
        return;
      }
      
      if(!gameState.selectedTeam || !gameState.isActive) {
        return;
      }

      const week = gameState.currentWeek;
      const team = gameState.selectedTeam;

      try {
        const { error } = await supabase
          .from('picks')
          .insert({
            user_id: currentUser.id,
            week: week,
            team: team,
            username: currentProfile.username
          });

        if(error) {
          if(error.code === '23505') {
            alert('Freeze!: Either you already picked this week, or you already picked that team. Contact KK to change your pick');
          } else {
            alert('Error submitting pick: ' + error.message);
          }
          return;
        }

        gameState.weeklyPicks.push({ week, team });
        const submitPickEl = document.getElementById('submitPick');
        if (submitPickEl) {
          submitPickEl.disabled = true;
        }

        const verdictEl = document.createElement('div');
        verdictEl.className = 'verdict slide-in';
        verdictEl.innerHTML = `<strong>DA McCoy:</strong> "The people have selected ${team} to lose in Week ${week}. Let's see if justice prevails."`;
        document.getElementById('teamSelection').appendChild(verdictEl);
        
        setTimeout(() => {
          if(verdictEl.parentNode) {
            verdictEl.remove();
          }
        }, 4500);

        await loadUserPicksAndDisableTeams();
        await refreshLeagueStats();

      } catch(error) {
        console.error('Unexpected error submitting pick:', error);
        alert('An unexpected error occurred while submitting your pick.');
      }
    }

    function renderUsedPicks(picks){
      const sectionEl = document.getElementById('usedTeamsSection');
      const listEl = document.getElementById('usedTeamsList');
      
      if(!picks || picks.length === 0) {
        sectionEl.style.display = 'none';
        listEl.innerHTML = '';
        return;
      }

      sectionEl.style.display = 'block';
      listEl.innerHTML = picks
        .map(p => `<div class="used-team" role="listitem">Week ${p.week} ‚Äî ${p.team}</div>`)
        .join('');
    }

    function renderTeams(){
      const teamGridEl = document.getElementById('teamGrid');
      teamGridEl.innerHTML = '';

      nflTeams.forEach((team) => {
        const isUsed = gameState.usedTeams.includes(team.name);
        const isSelected = gameState.selectedTeam === team.name;
        
        const cardEl = document.createElement('div');
        cardEl.className = 'team-card';
        cardEl.setAttribute('role', 'button');
        cardEl.setAttribute('tabindex', isUsed || !gameState.isActive ? '-1' : '0');
        cardEl.setAttribute('aria-pressed', isSelected ? 'true' : 'false');
        cardEl.setAttribute('aria-label', `Pick ${team.name}${isUsed ? ' (already used)' : ''}`);

        const teamPrimary = team.primary || '#4B5563';
        const teamSecondary = team.secondary || '#E5E7EB';
        
        cardEl.style.background = 'var(--bg-primary)';
        cardEl.style.color = 'var(--text-primary)';
        cardEl.style.borderLeftColor = teamPrimary;
        cardEl.style.setProperty('--team-primary', teamPrimary);
        cardEl.style.setProperty('--team-secondary', teamSecondary);

        cardEl.innerHTML = `
          <div class="team-name">${team.name}</div>
          ${isUsed ? '<div style="font-size:0.8rem;margin-top:4px;opacity:0.8">PICKED</div>' : ''}
        `;

        if(isUsed || !gameState.isActive) {
          cardEl.classList.add('disabled');
          cardEl.setAttribute('aria-disabled', 'true');
        } else {
          cardEl.addEventListener('click', () => selectTeam(team.name));
          cardEl.addEventListener('keydown', (e) => {
            if(e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              selectTeam(team.name);
            }
          });
        }

        if(isSelected && !isUsed) {
          cardEl.classList.add('selected');
        }

        teamGridEl.appendChild(cardEl);
      });
    }

    function selectTeam(teamName){
      if(gameState.usedTeams.includes(teamName) || !gameState.isActive) {
        return;
      }

      gameState.selectedTeam = teamName;
      renderTeams();
      const submitPickEl = document.getElementById('submitPick');
      if (submitPickEl) {
        submitPickEl.disabled = false;
      }
      
      const announcement = `Picked ${teamName}`;
      const ariaLiveEl = document.createElement('div');
      ariaLiveEl.setAttribute('aria-live', 'polite');
      ariaLiveEl.className = 'sr-only';
      ariaLiveEl.textContent = announcement;
      document.body.appendChild(ariaLiveEl);
      setTimeout(() => ariaLiveEl.remove(), 1000);
    }

    function updateStatus(){
      document.getElementById('currentWeek').textContent = gameState.currentWeek;
      document.getElementById('teamsUsedCount').textContent = gameState.usedTeams.length;
      document.getElementById('teamsRemaining').textContent = 32 - gameState.usedTeams.length;
      
      if(!currentProfile) {
        document.getElementById('playerName').textContent = 'Detective';
      }
      
      autoFitPlayerName();
    }

    function updateUsedTeams(){
      const sectionEl = document.getElementById('usedTeamsSection');
      const listEl = document.getElementById('usedTeamsList');
      
      if(gameState.usedTeams.length > 0) {
        sectionEl.style.display = 'block';
        listEl.innerHTML = gameState.usedTeams
          .map(team => `<div class="used-team" role="listitem">${team}</div>`)
          .join('');
      } else {
        sectionEl.style.display = 'none';
        listEl.innerHTML = '';
      }
    }

    function showGameOver(won = false, customMessage = null){
      const gameOverEl = document.getElementById('gameOverSection');
      const messageEl = document.getElementById('gameOverMessage');
      const verdictEl = document.getElementById('finalVerdict');

      if(won) {
        messageEl.textContent = customMessage || 
          `Congratulations! You navigated all 32 teams and made it through ${gameState.currentWeek - 1} weeks!`;
        verdictEl.innerHTML = 
          `<strong>Judge:</strong> "This court finds you NOT GUILTY of poor judgment. Case dismissed with honors!"`;
        verdictEl.style.borderLeftColor = 'var(--success)';
      } else {
        const failedTeam = gameState.selectedTeam || 'Unknown Team';
        messageEl.textContent = customMessage || 
          `Case closed! ${failedTeam} won in Week ${gameState.currentWeek}.`;
        verdictEl.innerHTML = 
          `<strong>Judge:</strong> "The defendant ${failedTeam} has been found NOT GUILTY of losing. Your prosecution has failed. Court adjourned."`;
        verdictEl.style.borderLeftColor = 'var(--error)';
      }

      gameOverEl.style.display = 'block';
      document.getElementById('teamSelection').style.display = 'none';
      
      gameOverEl.focus();
    }

    // Improved week advancement check with database support
    async function checkWeekAdvancement() {
      const centralTime = getCentralNow();
      
      // Check for Tuesday morning between 6 AM and 11 AM (wider window)
      if (centralTime.getDay() === 2 && centralTime.getHours() >= 6 && centralTime.getHours() <= 11) {
        try {
          // Get current week from database to see if someone else already advanced it
          const dbWeek = await getCurrentWeekFromDB();
          
          if (dbWeek > gameState.currentWeek) {
            // Someone else already advanced it
            gameState.currentWeek = dbWeek;
            gameState.selectedTeam = null;
            
            updateUI();
            return;
          }
          
          // Check if we should advance (hasn't been advanced today)
          const { data, error } = await supabase
            .from('game_settings')
            .select('last_updated')
            .eq('id', 1)
            .single();
          
          if (data?.last_updated) {
            const lastUpdate = new Date(data.last_updated);
            const today = new Date(centralTime);
            today.setHours(0, 0, 0, 0);
            
            if (lastUpdate >= today) {
              // Already advanced today
              return;
            }
          }
          
          // Advance the week
          const success = await advanceWeekInDB();
          if (success) {
            gameState.selectedTeam = null;
            updateUI();
            
            const verdictEl = document.createElement('div');
            verdictEl.className = 'verdict slide-in';
            verdictEl.innerHTML = 
              `<strong>Judge:</strong> "Court in session for Week ${gameState.currentWeek}. New cases await your judgment, Detective."`;
            document.getElementById('teamSelection').appendChild(verdictEl);
            
            setTimeout(() => {
              if(verdictEl.parentNode) {
                verdictEl.remove();
              }
            }, 4500);
          }
          
        } catch (error) {
          console.error('Error in week advancement:', error);
        }
      }
    }

    function updateUI() {
      renderTeams();
      updateStatus();
      if(currentUser && currentProfile) {
        loadUserPicksAndDisableTeams();
      }
    }

    function newGame(){
      gameState.selectedTeam = null;
      gameState.isActive = true;
      
      document.getElementById('gameOverSection').style.display = 'none';
      document.getElementById('teamSelection').style.display = 'block';
      const submitPickEl = document.getElementById('submitPick');
      if (submitPickEl) {
        submitPickEl.disabled = true;
      }
      
      renderTeams();
      updateStatus();
      updateUsedTeams();
      loadUserPicksAndDisableTeams();
    }

  async function fetchAllPicksPublic() {
    try {
      const { data, error } = await supabase
        .from('picks')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Error fetching league picks:', error);
        return [];
      }
      return data || [];
    } catch (error) {
      console.error('Unexpected error fetching league data:', error);
      return [];
    }
  }
  
  function renderLeagueStats(picks) {
    const users = new Map();
    const teamCounts = new Map();
    const statusCounts = new Map();

    for (const pick of picks) {
      const username = pick.username || '(unknown)';

      if (!users.has(username)) {
        users.set(username, { 
          weeks: new Set(), 
          teams: new Set(), 
          lastWeek: 0,
          allPicks: [],
          status: ''
        });
      }

      const userRecord = users.get(username);
      userRecord.weeks.add(pick.week);
      userRecord.teams.add(pick.team);
      userRecord.allPicks.push(pick);
      
      if (pick.week > userRecord.lastWeek) {
        userRecord.lastWeek = pick.week;
        // Store the exact database result field
        userRecord.status = pick.result || '';
      }

      teamCounts.set(pick.team, (teamCounts.get(pick.team) || 0) + 1);
    }

    // Count unique statuses
    for (const [username, record] of users.entries()) {
      const status = record.status || 'No Status';
      statusCounts.set(status, (statusCounts.get(status) || 0) + 1);
    }

    const totalPicks = picks.length;
    const totalPlayers = users.size;

    const topTeams = [...teamCounts.entries()]
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5)
      .map(([team, count]) => `${team} (${count})`)
      .join(' ¬∑ ');

    // Format status counts
    const statusCountsText = [...statusCounts.entries()]
      .sort((a, b) => b[1] - a[1])
      .map(([status, count]) => `${status} (${count})`)
      .join(' ¬∑ ');

    const summaryEl = document.getElementById('statsSummary');
    summaryEl.textContent = `Prosecutors: ${totalPlayers} ¬∑ Total Picks: ${totalPicks}` + 
      (statusCountsText ? ` ¬∑ Status: ${statusCountsText}` : '') +
      (topTeams ? ` ¬∑ Most Picked: ${topTeams}` : '');

    const userTableBody = document.getElementById('userSummaryBody');
    const userRows = [...users.entries()]
      .sort((a, b) => {
        const statusA = a[1].status || '';
        const statusB = b[1].status || '';
        
        // First sort by status alphabetically
        if (statusA !== statusB) {
          return statusA.localeCompare(statusB);
        }
        
        // Then sort by username alphabetically
        return a[0].localeCompare(b[0]);
      })
      .map(([username, record]) => {
        const weeksPicked = record.weeks.size;
        const teamsUsed = record.teams.size;
        const lastWeek = record.lastWeek || '-';
        const status = record.status;
        
        // Format status as a label with conditional coloring
        let statusDisplay = '';
        if (status) {
          const statusLower = status.toLowerCase();
          let labelClass = 'status-other';
          
          if (statusLower.includes('active')) {
            labelClass = 'status-active';
          } else if (statusLower.includes('eliminated')) {
            labelClass = 'status-eliminated';
          }
          
          statusDisplay = `<span class="status-label ${labelClass}">${status}</span>`;
        }

        return `
          <tr>
            <td><strong>@${username}</strong></td>
            <td>${statusDisplay}</td>
            <td>${weeksPicked}</td>
            <td>${teamsUsed}</td>
            <td>${lastWeek}</td>
          </tr>
        `;
      }).join('');

    userTableBody.innerHTML = userRows || 
      `<tr><td colspan="5" style="color:var(--text-tertiary);text-align:center;padding:24px;">No picks yet.</td></tr>`;

    const allPicksBody = document.getElementById('allPicksBody');
    const pickRows = picks.map(pick => {
      const createdAt = new Date(pick.created_at);
      const timestamp = isNaN(createdAt.getTime()) ? 
        'Invalid Date' : 
        createdAt.toLocaleString('en-US', {
          timeZone: 'America/Chicago',
          month: 'short',
          day: 'numeric',
          hour: 'numeric',
          minute: '2-digit'
        });
        
      return `
        <tr>
          <td><strong>Week ${pick.week}</strong></td>
          <td>@${pick.username || '(unknown)'}</td>
          <td>${pick.team}</td>
          <td style="color:var(--text-secondary);font-size:0.875rem;">${timestamp}</td>
        </tr>
      `;
    }).join('');

    allPicksBody.innerHTML = pickRows || 
      `<tr><td colspan="4" style="color:var(--text-tertiary);text-align:center;padding:24px;">No picks yet.</td></tr>`;
  }

  async function refreshLeagueStats() {
    const picks = await fetchAllPicksPublic();
    renderLeagueStats(picks);
  }
</script>

</body>
</html>