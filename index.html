<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Law & Order: Fantasy Football Elimination</title>

  <!-- Fonts (L&O-esque headers + clean sans body) -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Source+Sans+3:wght@400;700;800;900&display=swap" rel="stylesheet"/>

  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --lo-red:#cc0000;
      --lo-red-dark:#990000;
      --lo-blue:#000066;
      --lo-blue-mid:#003399;
      --ink:#111;
      --ink-2:#333;
      --ink-3:#666;
      --bg:#fff;
      --panel:#f8f8f8;
      --panel-2:#eee;
      --chip:#ddd;
      --rule:#ccc;
    }

    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Source Sans 3',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--ink);
      line-height:1.6;
      min-height:100vh;
    }

    /* Header */
    .header{
      background:var(--lo-red);
      padding:20px 0;
      text-align:center;
      border-bottom:8px solid var(--lo-blue);
    }
    .header h1{
      font-family:'Cinzel',serif;
      font-weight:900;
      font-size:2.4rem;
      color:#fff;
      letter-spacing:.5px;
    }
    .tagline{
      font:italic 400 1rem 'Source Sans 3',sans-serif;
      color:#f2f2f2;
      margin-top:6px;
    }

    .container{max-width:1100px;margin:0 auto;padding:20px}

    /* Auth bar + username gate */
    #authBar{
      display:flex;gap:8px;align-items:center;justify-content:center;margin:14px 0;flex-wrap:wrap
    }
    #authBar input{
      padding:6px 8px;border:1px solid var(--lo-blue)
    }
    .btn{
      padding:10px 18px;border:none;border-radius:3px;font-weight:800;text-transform:uppercase;cursor:pointer
    }
    .btn-primary{background:var(--lo-red);color:#fff}
    .btn-primary:hover{background:var(--lo-red-dark)}
    .btn-secondary{background:var(--lo-blue);color:#fff}
    .btn-secondary:hover{background:var(--lo-blue-mid)}
    .btn:disabled{opacity:.4;cursor:not-allowed}

    #usernameGate{
      display:none;max-width:520px;margin:10px auto;border:2px solid var(--lo-blue);
      padding:16px;background:#fff
    }
    #usernameGate h3{
      font-family:'Cinzel',serif;font-weight:700;color:var(--lo-blue);margin-bottom:8px
    }

    /* Cards/blocks */
    .game-info,.team-selection,.game-over{
      background:var(--panel);
      border:2px solid var(--lo-blue);
      border-radius:4px;
      padding:22px;
      margin:18px 0;
    }
    .game-info{border-color:var(--lo-red)}
    .game-info h2,.team-selection h2,.game-over h2,.used-teams h3,.status-card h3{
      font-family:'Cinzel',serif;font-weight:700;letter-spacing:.3px;color:var(--lo-blue)
    }
    .game-info h2{color:var(--lo-blue)}
    .verdict{
      background:#fff;border-left:5px solid var(--lo-blue);padding:16px;margin:16px 0;
      font-style:italic;border-radius:0 4px 4px 0
    }

    /* Status bar */
    .status-bar{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:16px;margin:18px 0
    }
    .status-card{
      background:var(--panel-2);padding:18px;text-align:center;border:2px solid var(--lo-blue);border-radius:4px
    }
    .status-card .value{
      font-size:1.4rem;font-weight:900;color:var(--lo-red)
    }

    /* Team grid */
    .team-grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-top:16px
    }
    .team-card{
      border-radius:4px;padding:18px;text-align:center;border:2px solid var(--rule);
      background:#fff;transition:background .15s ease,transform .15s ease
    }
    .team-card:hover{background:#f3f3f3;transform:translateY(-2px)}
    .team-card.disabled{opacity:.5;cursor:not-allowed}
    .team-name{font-weight:900}

    /* Used teams */
    .used-teams{
      background:#f2f2f2;border:2px solid #999;border-radius:4px;padding:18px;margin:18px 0
    }
    .used-list{display:flex;flex-wrap:wrap;gap:8px}
    .used-team{background:var(--chip);padding:6px 10px;border-radius:16px;font-size:.85rem;font-weight:700}

    .action-buttons{display:flex;gap:12px;justify-content:center;margin:24px 0}
    .footer{border-top:2px solid var(--rule);text-align:center;color:var(--ink-3);padding:16px;margin-top:30px;font-size:.9rem}

    @media (max-width:768px){
      .header h1{font-size:1.9rem}
      .action-buttons{flex-direction:column}
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>LAW & ORDER: FANTASY FOOTBALL ELIMINATION</h1>
    <p class="tagline">‚ÄúIn the NFL justice system, the people are represented by two separate yet equally important groups: those who win, and those who lose. These are their stories.‚Äù</p>
  </div>

  <div class="container">

    <!-- Auth bar -->
    <div id="authBar">
      <div id="authWhenLoggedOut" style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;">
        <input id="authEmail" type="email" placeholder="Email"/>
        <input id="authPass" type="password" placeholder="Password"/>
        <button id="btnSignUp" class="btn btn-secondary">Sign Up</button>
        <button id="btnSignIn" class="btn btn-secondary">Sign In</button>
      </div>
      <div id="authWhenLoggedIn" style="display:none;gap:8px;align-items:center;flex-wrap:wrap;">
        <span id="displayUser" style="font-weight:900;color:var(--lo-blue)"></span>
        <button id="btnSignOut" class="btn btn-secondary">Sign Out</button>
      </div>
    </div>

    <!-- One-time username gate -->
    <div id="usernameGate">
      <h3>Choose a Username</h3>
      <p style="margin-bottom:10px">Pick a public handle for the game (3‚Äì20 letters/numbers/underscore). Cannot be changed later.</p>
      <input id="usernameInput" type="text" placeholder="Username" style="padding:8px;border:1px solid var(--lo-blue);width:100%;margin-bottom:10px;"/>
      <button id="btnSaveUsername" class="btn btn-primary">Save Username</button>
      <div id="usernameError" style="color:var(--lo-red);margin-top:8px"></div>
    </div>

    <div class="game-info">
      <h2>üèõÔ∏è The Case File</h2>
      <p><strong>The Rules:</strong> Each week, you must select one NFL team that you believe will <em>lose</em> their game. If your selected team loses, you advance. If they win or tie, you‚Äôre out. You can use each team only once per season.</p>
      <div class="verdict"><strong>Detective Briscoe:</strong> ‚ÄúWe‚Äôre betting on losers? Sounds like my ex-wife‚Äôs dating strategy.‚Äù</div>
    </div>

    <div class="status-bar">
      <div class="status-card">
        <h3>Player</h3>
        <div class="value" id="playerName">Detective</div>
      </div>
      <div class="status-card">
        <h3>Current Week</h3>
        <div class="value" id="currentWeek">1</div>
      </div>
      <div class="status-card">
        <h3>Teams Used</h3>
        <div class="value" id="teamsUsedCount">0</div>
      </div>
      <div class="status-card">
        <h3>Teams Remaining</h3>
        <div class="value" id="teamsRemaining">32</div>
      </div>
      <div class="status-card">
        <h3>Status</h3>
        <div class="value" id="gameStatus">Active</div>
      </div>
    </div>

    <div class="team-selection" id="teamSelection">
      <h2>‚öñÔ∏è Select Your Weekly Defendant</h2>
      <p>Choose the team you believe will lose this week:</p>
      <div class="team-grid" id="teamGrid"></div>
      <div id="alreadyPickedMsg" style="margin-top:10px;color:var(--lo-blue);font-weight:700;display:none;"></div>
    </div>

    <div class="action-buttons">
      <button class="btn btn-primary" id="submitPick" disabled>Submit Your Verdict</button>
      <button class="btn btn-secondary" id="simulateWeek" disabled>Simulate Week Results</button>
      <button class="btn btn-secondary" id="newGame">Reset UI</button>
    </div>

    <div class="used-teams" id="usedTeamsSection" style="display:none;">
      <h3>üóÇÔ∏è Case Files Closed (Your Picks)</h3>
      <div class="used-list" id="usedTeamsList"></div>
    </div>

    <div class="game-over" id="gameOverSection" style="display:none;">
      <h2>‚öñÔ∏è CASE CLOSED</h2>
      <p id="gameOverMessage"></p>
      <div class="verdict" id="finalVerdict"></div>
    </div>
  </div>

  <div class="footer">
    <p>Executive Producer: Dick Wolf ¬∑ ‚ÄúThese stories are fictional. Any resemblance to actual fantasy football leagues is purely coincidental.‚Äù</p>
  </div>

  <script>
/* =======================
   0) CONFIG: Supabase 
   ======================= */
const SUPABASE_URL = 'https://jdyjyzakcfmvwdfgzzyz.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkeWp5emFrY2ZtdndkZmd6enl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyNjAxNDQsImV4cCI6MjA3MTgzNjE0NH0.8gQ5Xg0HhZBI61i6XS-kK9Ui-3DxRywXT40OB9YNIbI';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* =======================
       1) NFL Teams (flat UI)
       ======================= */
    const nflTeams = [
      { name: "Arizona Cardinals",    primary: "#97233F" },
      { name: "Atlanta Falcons",      primary: "#A71930" },
      { name: "Baltimore Ravens",     primary: "#241773" },
      { name: "Buffalo Bills",        primary: "#00338D" },
      { name: "Carolina Panthers",    primary: "#0085CA" },
      { name: "Chicago Bears",        primary: "#0B162A" },
      { name: "Cincinnati Bengals",   primary: "#FB4F14" },
      { name: "Cleveland Browns",     primary: "#311D00" },
      { name: "Dallas Cowboys",       primary: "#003594" },
      { name: "Denver Broncos",       primary: "#FB4F14" },
      { name: "Detroit Lions",        primary: "#0076B6" },
      { name: "Green Bay Packers",    primary: "#203731" },
      { name: "Houston Texans",       primary: "#03202F" },
      { name: "Indianapolis Colts",   primary: "#002C5F" },
      { name: "Jacksonville Jaguars", primary: "#101820" },
      { name: "Kansas City Chiefs",   primary: "#E31837" },
      { name: "Las Vegas Raiders",    primary: "#000000" },
      { name: "Los Angeles Chargers", primary: "#0080C6" },
      { name: "Los Angeles Rams",     primary: "#003594" },
      { name: "Miami Dolphins",       primary: "#008E97" },
      { name: "Minnesota Vikings",    primary: "#4F2683" },
      { name: "New England Patriots", primary: "#002244" },
      { name: "New Orleans Saints",   primary: "#101820" },
      { name: "New York Giants",      primary: "#0B2265" },
      { name: "New York Jets",        primary: "#125740" },
      { name: "Philadelphia Eagles",  primary: "#004C54" },
      { name: "Pittsburgh Steelers",  primary: "#FFB612" },
      { name: "San Francisco 49ers",  primary: "#AA0000" },
      { name: "Seattle Seahawks",     primary: "#002244" },
      { name: "Tampa Bay Buccaneers", primary: "#D50A0A" },
      { name: "Tennessee Titans",     primary: "#0C2340" },
      { name: "Washington Commanders",primary: "#5A1414" }
    ];

    /* =======================
       2) Game State (UI-only)
       ======================= */
    let gameState = {
      currentWeek: 1,
      usedTeams: [],              // Set from DB picks
      selectedTeam: null,
      isActive: true,
      weeklyPicks: [],            // UI echo
      lastWeekAdvancement: 0
    };

    function getCentralNow(){
      const now = new Date();
      return new Date(now.toLocaleString("en-US", { timeZone: "America/Chicago" }));
    }

    /* =======================
       3) AUTH + PROFILE
       ======================= */
    let currentUser = null;
    let currentProfile = null;

    async function refreshAuthUI(){
      const { data: { user } } = await supabase.auth.getUser();
      currentUser = user || null;

      const out  = document.getElementById('authWhenLoggedOut');
      const inn  = document.getElementById('authWhenLoggedIn');
      const gate = document.getElementById('usernameGate');
      const nameEl = document.getElementById('displayUser');

      if(!currentUser){
        out.style.display='flex';
        inn.style.display='none';
        gate.style.display='none';
        nameEl.textContent='';
        document.getElementById('submitPick').disabled = true;
        document.getElementById('simulateWeek').disabled = true;
        document.getElementById('playerName').textContent = 'Detective';
        return;
      }

      out.style.display='none';
      inn.style.display='flex';

      const { data: profile } = await supabase.from('profiles').select('*').eq('id', currentUser.id).maybeSingle();

      if(!profile){
        gate.style.display='block';
        currentProfile = null;
        nameEl.textContent = '(set username)';
      }else{
        gate.style.display='none';
        currentProfile = profile;
        nameEl.textContent = '@' + profile.username;
        document.getElementById('playerName').textContent = '@' + profile.username;
        await loadUserPicksAndDisableTeams();
      }
    }

    document.getElementById('btnSignUp').addEventListener('click', async ()=>{
      const email = document.getElementById('authEmail').value.trim();
      const password = document.getElementById('authPass').value;
      const { error } = await supabase.auth.signUp({ email, password });
      if(error) alert(error.message); else alert('Check your email to confirm signup.');
    });

    document.getElementById('btnSignIn').addEventListener('click', async ()=>{
      const email = document.getElementById('authEmail').value.trim();
      const password = document.getElementById('authPass').value;
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if(error) alert(error.message);
      await refreshAuthUI();
    });

    document.getElementById('btnSignOut').addEventListener('click', async ()=>{
      await supabase.auth.signOut();
      gameState.selectedTeam = null;
      await refreshAuthUI();
      renderTeams(); updateStatus(); updateUsedTeams();
    });

    document.getElementById('btnSaveUsername').addEventListener('click', async ()=>{
      const u = document.getElementById('usernameInput').value.trim();
      const errEl = document.getElementById('usernameError');
      errEl.textContent = '';
      if(!u || !/^[a-zA-Z0-9_]{3,20}$/.test(u)){
        errEl.textContent = 'Username must be 3‚Äì20 chars, letters/numbers/underscore only.'; return;
      }
      const { error } = await supabase.from('profiles').insert({ id: currentUser.id, username: u });
      if(error){
        errEl.textContent = (error.code === '23505') ? 'That username is taken.' : error.message; return;
      }
      document.getElementById('usernameGate').style.display='none';
      await refreshAuthUI();
    });

    supabase.auth.onAuthStateChange((_event,_session)=>{ refreshAuthUI(); });

    /* =======================
       4) PICKS (DB source of truth)
       ======================= */
    async function loadUserPicksAndDisableTeams(){
      if(!currentUser) return;
      const { data: picks, error } = await supabase
        .from('picks')
        .select('week,team')
        .eq('user_id', currentUser.id)
        .order('week', { ascending:true });

      if(error){ console.error(error); return; }

      gameState.usedTeams = picks.map(p=>p.team);
      gameState.weeklyPicks = picks.slice();

      // Disable submit if already picked this week
      const already = picks.find(p=>p.week === gameState.currentWeek);
      const msgEl = document.getElementById('alreadyPickedMsg');
      if(already){
        document.getElementById('submitPick').disabled = true;
        document.getElementById('simulateWeek').disabled = true;
        msgEl.style.display = 'block';
        msgEl.textContent = `You already picked Week ${already.week}: ${already.team}.`;
      }else{
        msgEl.style.display = 'none';
      }

      renderTeams(); updateStatus(); renderUsedPicks(picks);
    }

    async function submitPick(){
      if(!currentUser){ alert('Please sign in first.'); return; }
      if(!currentProfile){ alert('Please set a username to play.'); return; }
      if(!gameState.selectedTeam || !gameState.isActive) return;

      const week = gameState.currentWeek;
      const team = gameState.selectedTeam;

      const { error } = await supabase.from('picks').insert({
        user_id: currentUser.id, week, team
      });

      if(error){
        if(error.code==='23505'){
          alert('Rule violation: Either you already picked this week, or you already used that team.');
        }else{
          alert(error.message);
        }
        return;
      }

      // UI echo + lock
      gameState.weeklyPicks.push({ week, team });
      document.getElementById('submitPick').disabled = true;
      document.getElementById('simulateWeek').disabled = true;

      const verdict = document.createElement('div');
      verdict.className = 'verdict';
      verdict.innerHTML = `<strong>DA McCoy:</strong> "The people have selected ${team} to lose in Week ${week}. Let's see if justice prevails."`;
      document.getElementById('teamSelection').appendChild(verdict);
      setTimeout(()=>verdict.remove(), 4500);

      await loadUserPicksAndDisableTeams();
    }

    function renderUsedPicks(picks){
      const section = document.getElementById('usedTeamsSection');
      const list = document.getElementById('usedTeamsList');
      if((picks||[]).length === 0){ section.style.display='none'; list.innerHTML=''; return; }
      section.style.display='block';
      list.innerHTML = picks.map(p=>`<div class="used-team">Week ${p.week} ‚Äî ${p.team}</div>`).join('');
    }

    /* =======================
       5) UI rendering
       ======================= */
    function renderTeams(){
      const teamGrid = document.getElementById('teamGrid');
      teamGrid.innerHTML = '';
      nflTeams.forEach((team)=>{
        const isUsed = gameState.usedTeams.includes(team.name);
        const card = document.createElement('div');
        card.className = 'team-card';
        card.style.borderColor = isUsed ? '#999' : team.primary;
        card.innerHTML = `
          <div class="team-name">${team.name}</div>
          ${isUsed ? '<div style="color:#777;font-size:.85rem">CASE CLOSED</div>' : ''}
        `;
        if(isUsed || !gameState.isActive){
          card.classList.add('disabled');
        }else{
          card.addEventListener('click', ()=>selectTeam(team.name));
        }
        // selected outline
        if(gameState.selectedTeam === team.name && !isUsed){
          card.style.outline = `3px solid ${team.primary}`;
          card.style.outlineOffset = '2px';
        }
        teamGrid.appendChild(card);
      });
    }

    function selectTeam(teamName){
      if(gameState.usedTeams.includes(teamName) || !gameState.isActive) return;
      gameState.selectedTeam = teamName;
      renderTeams();
      document.getElementById('submitPick').disabled = false;
    }

    function showGameOver(won=false, customMessage=null){
      const gameOverSection = document.getElementById('gameOverSection');
      const message = document.getElementById('gameOverMessage');
      const verdict = document.getElementById('finalVerdict');
      if(won){
        message.textContent = customMessage || `Congratulations! You navigated all 32 teams and made it through ${gameState.currentWeek-1} weeks!`;
        verdict.innerHTML = `<strong>Judge:</strong> "This court finds you NOT GUILTY of poor judgment. Case dismissed with honors!"`;
        verdict.style.borderLeftColor = '#4CAF50';
      }else{
        const failedTeam = gameState.selectedTeam || 'Unknown Team';
        message.textContent = customMessage || `Case closed! ${failedTeam} won in Week ${gameState.currentWeek}.`;
        verdict.innerHTML = `<strong>Judge:</strong> "The defendant ${failedTeam} has been found NOT GUILTY of losing. Your prosecution has failed. Court adjourned."`;
        verdict.style.borderLeftColor = varLoRed();
      }
      gameOverSection.style.display='block';
      document.getElementById('teamSelection').style.display='none';
    }
    function varLoRed(){ return getComputedStyle(document.documentElement).getPropertyValue('--lo-red'); }

    function updateStatus(){
      document.getElementById('currentWeek').textContent = gameState.currentWeek;
      document.getElementById('teamsUsedCount').textContent = gameState.usedTeams.length;
      document.getElementById('teamsRemaining').textContent = 32 - gameState.usedTeams.length;
      document.getElementById('gameStatus').textContent = gameState.isActive ? 'Active' : 'Closed';
      if(!currentProfile){
        document.getElementById('playerName').textContent = 'Detective';
      }
    }

    // Optional local simulate (for testing only)
    function simulateWeek(){
      if(!gameState.selectedTeam || !gameState.isActive) return;
      const teamLoses = Math.random() < 0.7;
      if(teamLoses){
        gameState.usedTeams.push(gameState.selectedTeam);
        gameState.currentWeek++;
        gameState.selectedTeam = null;
        const verdict = document.createElement('div');
        verdict.className = 'verdict';
        verdict.style.borderLeftColor = '#4CAF50';
        verdict.innerHTML = `<strong>Judge:</strong> "The defendant has been found GUILTY of losing. Proceed to Week ${gameState.currentWeek}."`;
        document.getElementById('teamSelection').appendChild(verdict);
        setTimeout(()=>verdict.remove(), 4500);
      }else{
        gameState.isActive = false;
        showGameOver(false);
      }
      renderTeams(); updateStatus(); updateUsedTeams();
      document.getElementById('submitPick').disabled = true;
      document.getElementById('simulateWeek').disabled = true;
    }

    function updateUsedTeams(){
      const section = document.getElementById('usedTeamsSection');
      const list = document.getElementById('usedTeamsList');
      if(gameState.usedTeams.length > 0){
        section.style.display='block';
        list.innerHTML = gameState.usedTeams.map(t=>`<div class="used-team">${t}</div>`).join('');
      }else{
        section.style.display='none';
        list.innerHTML='';
      }
    }

    // Monday 00:00 CT advance (UI only)
    function checkWeekAdvancement(){
      const ct = getCentralNow();
      if(ct.getDay()===1 && ct.getHours()===0 && ct.getMinutes()===0){
        const last = gameState.lastWeekAdvancement || 0;
        const currentStart = new Date(ct); currentStart.setHours(0,0,0,0);
        if(currentStart.getTime() > last && gameState.isActive){
          gameState.currentWeek++;
          gameState.selectedTeam = null;
          gameState.lastWeekAdvancement = Date.now();
          document.getElementById('submitPick').disabled = true;
          document.getElementById('simulateWeek').disabled = true;
          const v = document.createElement('div');
          v.className='verdict';
          v.innerHTML = `<strong>Judge:</strong> "Court in session for Week ${gameState.currentWeek}. New cases await your judgment, Detective."`;
          document.getElementById('teamSelection').appendChild(v);
          setTimeout(()=>v.remove(), 4500);
          renderTeams(); updateStatus();
        }
      }
    }

    // Reset UI (does NOT delete DB picks)
    function newGame(){
      gameState.selectedTeam = null;
      gameState.isActive = true;
      document.getElementById('gameOverSection').style.display='none';
      document.getElementById('teamSelection').style.display='block';
      document.getElementById('submitPick').disabled = true;
      document.getElementById('simulateWeek').disabled = true;
      renderTeams(); updateStatus(); updateUsedTeams();
      loadUserPicksAndDisableTeams();
    }

    // Listeners
    document.getElementById('submitPick').addEventListener('click', submitPick);
    document.getElementById('simulateWeek').addEventListener('click', simulateWeek);
    document.getElementById('newGame').addEventListener('click', newGame);

    // Init
    (async function init(){
      renderTeams(); updateStatus(); updateUsedTeams();
      await refreshAuthUI();
      setInterval(checkWeekAdvancement, 60000);
    })();
  </script>
</body>
</html>
