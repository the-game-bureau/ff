<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- Page title - will be replaced with {title} from src/themes/themes.xml -->
  <title>Kevin Kolb's Losers Game</title>

  <!-- Theme CSS - dynamically loaded based on URL parameter -->
  <script>
    (function() {
      const urlParams = new URLSearchParams(window.location.search);
      const themeId = urlParams.get('theme') || '1';
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = `src/themes/${themeId}.css`;
      document.head.appendChild(link);
    })();
  </script>

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="src/lawandorder.jpg"/>
  <link rel="apple-touch-icon" sizes="180x180" href="src/lawandorder.jpg"/>
  <link rel="icon" type="image/png" sizes="32x32" href="src/lawandorder.jpg"/>
  <link rel="icon" type="image/png" sizes="16x16" href="src/lawandorder.jpg"/>
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website"/>
  <meta property="og:url" content="https://lawandorder-svu.app/"/>
  <meta property="og:title" content="Law & Order: Special Victory Unit"/>
  <meta property="og:description" content="In the NFL justice system, the people are represented by two separate yet equally important groups: those who win, and those who lose. These are their stories."/>
  <meta property="og:image" content="src/lawandorder.jpg"/>
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image"/>
  <meta property="twitter:url" content="https://lawandorder-svu.app/"/>
  <meta property="twitter:title" content="Law & Order: Special Victory Unit"/>
  <meta property="twitter:description" content="In the NFL justice system, the people are represented by two separate yet equally important groups: those who win, and those who lose. These are their stories."/>
  <meta property="twitter:image" content="src/lawandorder.jpg"/>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

</head>

<body>
  <header class="header" role="banner">
    <div class="header-logo-text">
      <!-- titleLine1 & titleLine2 will be loaded from src/themes/themes.xml -->
      <div class="title1"><span class="ampersand">&</span></div>
      <div class="order-text"></div>
    </div>
    <!-- titleLine3 will be loaded from src/themes/themes.xml -->
    <div class="svu-subtitle"></div>
    <h1>Law & Order: Special Victory Unit</h1>
    <p class="tagline"></p>
  </header>

  <div class="container">
    <section class="game-info" aria-labelledby="gameInfoTitle">
      <h2 id="gameInfoTitle">üèõÔ∏è The Law</h2>
      <p>Each week, you must select one NFL team that you believe will <em>lose</em> their game. If your selected team loses, you advance. If they win or tie, you're out. You can use each team only once per season. No draft, no grand jury necessary.</p>

      <div class="verdict" role="note">
        <strong>Detective Briscoe:</strong> "We're betting on losers? Easy! I pick losers at the track every weekend."
      </div>
    </section>

    <section class="game-info" id="authStatusContainer">
      <div id="authBar" role="complementary" aria-label="User authentication">
        <div id="authWhenLoggedOut" style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;">
          <input id="authEmail" type="email" placeholder="Email" aria-label="Email address" />
          <input id="authPass" type="password" placeholder="Password" aria-label="Password" />
          <!-- <button id="btnSignUp" class="btn btn-secondary" type="button">Sign Up</button> -->
          <button id="btnSignIn" class="btn btn-secondary" type="button">Sign In</button>
          <button id="btnResetPassword" class="btn btn-secondary" type="button">Reset Password</button>
        </div>

        <div id="authWhenLoggedIn" style="display:none;gap:8px;align-items:center;flex-wrap:wrap;">
          <span id="displayUser" style="font-weight:600;color:var(--primary-blue)" aria-label="Current user"></span>
          <button id="btnSignOut" class="btn btn-secondary" type="button">Sign Out</button>
        </div>
      </div>

      <div id="usernameGate" role="dialog" aria-labelledby="usernameGateTitle" aria-hidden="true">
        <h3 id="usernameGateTitle">Choose a Username</h3>
        <p style="margin-bottom:16px;color:var(--text-secondary);line-height:1.4">Pick a public handle for the game (3‚Äì20 letters/numbers/underscore). Cannot be changed later.</p>
        <input id="usernameInput" type="text" placeholder="Username" aria-label="Username" style="padding:12px;border:2px solid var(--bg-accent);width:100%;margin-bottom:16px;font-family:inherit;"/>
        <button id="btnSaveUsername" class="btn btn-primary" type="button">Save Username</button>
        <div id="usernameError" role="alert" style="color:var(--error);margin-top:12px;font-weight:600"></div>
      </div>

      <section class="status-bar" id="statusBar" style="display:none;" aria-label="Game status overview">
        <div class="status-line" id="playerStatusCard">
          <span>Week <strong id="currentWeek">11</strong></span><!-- Auto-updated by JavaScript -->
          <span class="separator">¬∑</span>
          <span>Teams Used: <strong id="teamsUsedCount">0</strong></span>
          <span class="separator">¬∑</span>
          <span>Teams Remaining: <strong id="teamsRemaining">32</strong></span>
          <span class="separator">¬∑</span>
          <span>Status: <strong id="playerStatus">-</strong></span>
        </div>
      </section>
    </section>

    <section class="game-info" id="eliminationChart" aria-labelledby="eliminationChartTitle">
      <h3 id="eliminationChartTitle" style="margin:0 0 16px;font-weight:700;color:var(--primary-blue);text-transform:uppercase;">
        ‚öñÔ∏è League Timeline
      </h3>
      <div id="chartContainer" style="margin-top:20px;"></div>
    </section>

    <section class="team-selection" id="teamSelection" aria-labelledby="teamSelectionTitle">
      <h2 id="teamSelectionTitle">üèà Suspect Lineup</h2>
      <p id="teamSelectionSubtitle">(Pick a team you believe will lose in week 8):</p>

      <div class="team-grid" id="teamGrid" role="group" aria-label="NFL teams pick"></div>

      <div id="alreadyPickedMsg"
           role="alert"
           aria-live="polite"
           style="margin-top:16px;color:var(--primary-blue);font-weight:600;display:none;"></div>

      <section class="action-buttons" role="group" aria-label="Game actions">
        <button class="btn btn-primary" id="submitPick" disabled aria-describedby="submitPickHelp">
          Submit Your Suspect
        </button>

        <div class="sr-only">
          <div id="submitPickHelp">Submit your team pick for this week</div>
        </div>
      </section>
    </section>

    <section class="game-over" id="gameOverSection" style="display:none;" aria-labelledby="gameOverTitle">
      <h2 id="gameOverTitle">‚öñÔ∏è CASE CLOSED</h2>
      <p id="gameOverMessage" role="status"></p>
      <div class="verdict" id="finalVerdict" role="note"></div>
    </section>

    <section class="game-info" id="leagueStats" aria-labelledby="leagueStatsTitle">
<h3 style="margin:0 0 16px;font-weight:700;color:var(--primary-blue);text-transform:uppercase;">
  üîê Evidence Locker
</h3>

<div id="statsSummary" 
     style="margin:16px 0 24px;color:var(--primary-blue);font-weight:600"
     aria-live="polite"></div>

<div style="overflow:auto;border:2px solid var(--primary-blue);background:var(--bg-primary);margin-bottom:24px">
  <table id="userSummaryTable" role="table" aria-label="User summary statistics">
    <caption class="sr-only">Summary of all users' picks and activity</caption>
    <thead>
      <tr>
        <th scope="col">Status</th>
        <th scope="col">User</th>
        <th scope="col">Status</th>
      </tr>
    </thead>
    <tbody id="userSummaryBody"></tbody>
  </table>
</div>

    </section>

  </div>

  <footer class="footer" role="contentinfo">
    <p>Executive Producer: Dick Wolf ¬∑ "These stories are fictional. Any resemblance to actual fantasy football leagues is purely coincidental."</p>
  </footer>

  <!-- Floating Schedule Toggle Button -->
  <button id="toggleScheduleBtn" aria-label="Toggle NFL Schedule" title="View NFL Schedule">
    üèà
  </button>

  <!-- Floating Schedule Container -->
  <div id="floatingScheduleContainer" role="dialog" aria-labelledby="scheduleTitle" aria-modal="false">
    <div class="schedule-header">
      <span id="scheduleTitle">NFL Week Schedule</span>
      <button class="schedule-close" id="closeScheduleBtn" aria-label="Close schedule">√ó</button>
    </div>
    <iframe id="scheduleIframe" title="NFL Schedule" sandbox="allow-same-origin allow-scripts" loading="lazy"></iframe>
  </div>

  <!-- Floating Pick Ticker Toggle Button -->
  <button id="togglePickTickerBtn" aria-label="Toggle Pick Ticker" title="View Pick Ticker">
    üìã
  </button>

  <!-- Floating Pick Ticker Container -->
  <div id="floatingPickTickerContainer" role="dialog" aria-labelledby="pickTickerTitle" aria-modal="false">
    <div class="schedule-header">
      <button id="prevPickWeekBtn" class="week-nav-btn" aria-label="Previous week">‚óÄ</button>
      <span id="pickTickerTitle">Pick Ticker Week 8</span>
      <button id="nextPickWeekBtn" class="week-nav-btn" aria-label="Next week">‚ñ∂</button>
      <button class="schedule-close" id="closePickTickerBtn" aria-label="Close pick ticker">√ó</button>
    </div>
    <div id="pickTickerContent" style="flex: 1; overflow: auto; padding: 16px; background: var(--bg-primary);">
      <div style="overflow:auto;border:2px solid var(--primary-blue);background:var(--bg-primary)">
        <table id="floatingPicksTable" role="table" aria-label="User picks for selected week">
          <caption class="sr-only">Picks made by users for the selected week</caption>
          <thead>
            <tr>
              <th scope="col">User</th>
              <th scope="col">Team</th>
              <th scope="col">Picked At</th>
            </tr>
          </thead>
          <tbody id="floatingPicksBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Theme loader from XML
    let currentTheme = null;

    async function loadTheme(themeId) {
      try {
        const response = await fetch('src/themes/themes.xml');
        const xmlText = await response.text();
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, 'text/xml');

        const themes = xmlDoc.querySelectorAll('theme');
        for (const theme of themes) {
          if (theme.getAttribute('id') === themeId.toString()) {
            currentTheme = {
              title: theme.querySelector('title')?.textContent || '',
              primaryColor: theme.querySelector('primaryColor')?.textContent || '#DC2626',
              secondaryColor: theme.querySelector('secondaryColor')?.textContent || '#1E40AF',
              quote1: theme.querySelector('quote1')?.textContent || '',
              tagline: theme.querySelector('tagline')?.textContent || ''
            };
            return currentTheme;
          }
        }
      } catch (error) {
        console.error('Error loading theme:', error);
      }
      return null;
    }

    function applyTheme(theme) {
      if (!theme) return;

      // Update page title (appears in browser tab)
      // Uses the combined "title" field from XML (e.g., "Law & Order: Special Victory Unit")
      document.title = theme.title;
      const h1 = document.querySelector('.header h1');
      if (h1) h1.textContent = theme.title;

      // Update header display with three separate title lines
      // titleLine1 = first word (e.g., "Law")
      // titleLine2 = second word (e.g., "Order")
      // titleLine3 = subtitle (e.g., "Special Victory Unit")
      if (theme.titleLine1 && theme.titleLine2 && theme.titleLine3) {
        const svuSubtitle = document.querySelector('.svu-subtitle');
        if (svuSubtitle) svuSubtitle.textContent = theme.titleLine3;

        const headerLogoText = document.querySelector('.header-logo-text');
        if (headerLogoText) {
          headerLogoText.innerHTML = `
            <div class="title1">${theme.titleLine1.toUpperCase()}<span class="ampersand">&</span></div>
            <div class="order-text">${theme.titleLine2.toUpperCase()}</div>
          `;
        }
      }

      // Update tagline
      const taglineEl = document.querySelector('.tagline');
      if (taglineEl) taglineEl.textContent = `"${theme.tagline}"`;

      // Update quote1
      const verdictEl = document.querySelector('.verdict strong');
      if (verdictEl && verdictEl.nextSibling) {
        verdictEl.nextSibling.textContent = ` "${theme.quote1.split(': "')[1]}`;
      }

      // Update CSS variables for colors
      const root = document.documentElement;
      root.style.setProperty('--primary-red', theme.primaryColor);
      root.style.setProperty('--primary-red-dark', adjustColor(theme.primaryColor, -20));
      root.style.setProperty('--primary-blue', theme.secondaryColor);
      root.style.setProperty('--primary-blue-mid', adjustColor(theme.secondaryColor, 10));
    }

    function adjustColor(color, percent) {
      const num = parseInt(color.replace('#', ''), 16);
      const amt = Math.round(2.55 * percent);
      const R = (num >> 16) + amt;
      const G = (num >> 8 & 0x00FF) + amt;
      const B = (num & 0x0000FF) + amt;
      return '#' + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
        (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
        (B < 255 ? B < 1 ? 0 : B : 255))
        .toString(16).slice(1);
    }

    // Check URL for theme parameter, default to theme 1
    const urlParams = new URLSearchParams(window.location.search);
    const themeId = urlParams.get('theme') || '1';

    if (themeId) {
      loadTheme(themeId).then(theme => {
        if (theme) {
          applyTheme(theme);
        }
      });
    }

    const SUPABASE_URL = 'https://jdyjyzakcfmvwdfgzzyz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkeWp5emFrY2ZtdndkZmd6enl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyNjAxNDQsImV4cCI6MjA3MTgzNjE0NH0.8gQ5Xg0HhZBI61i6XS-kK9Ui-3DxRywXT40OB9YNIbI';
    
    // FIXED: Added session persistence to prevent auth cycling
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        storageKey: 'law-order-svu-auth',
        storage: window.localStorage
      }
    });

    const nflTeams = [
      { name: "Arizona Cardinals",    primary: "#97233F", secondary: "#FFB612" },
      { name: "Atlanta Falcons",      primary: "#A71930", secondary: "#000000" },
      { name: "Baltimore Ravens",     primary: "#241773", secondary: "#9E7C0C" },
      { name: "Buffalo Bills",        primary: "#00338D", secondary: "#C60C30" },
      { name: "Carolina Panthers",    primary: "#0085CA", secondary: "#BFC0BF" },
      { name: "Chicago Bears",        primary: "#0B162A", secondary: "#C83803" },
      { name: "Cincinnati Bengals",   primary: "#FB4F14", secondary: "#000000" },
      { name: "Cleveland Browns",     primary: "#311D00", secondary: "#FF3C00" },
      { name: "Dallas Cowboys",       primary: "#003594", secondary: "#869397" },
      { name: "Denver Broncos",       primary: "#FB4F14", secondary: "#002244" },
      { name: "Detroit Lions",        primary: "#0076B6", secondary: "#B0B7BC" },
      { name: "Green Bay Packers",    primary: "#203731", secondary: "#FFB612" },
      { name: "Houston Texans",       primary: "#03202F", secondary: "#A71930" },
      { name: "Indianapolis Colts",   primary: "#002C5F", secondary: "#A5ACAF" },
      { name: "Jacksonville Jaguars", primary: "#101820", secondary: "#D7A22A" },
      { name: "Kansas City Chiefs",   primary: "#E31837", secondary: "#FFB81C" },
      { name: "Las Vegas Raiders",    primary: "#000000", secondary: "#A5ACAF" },
      { name: "Los Angeles Chargers", primary: "#0080C6", secondary: "#FFC20E" },
      { name: "Los Angeles Rams",     primary: "#003594", secondary: "#FFA300" },
      { name: "Miami Dolphins",       primary: "#008E97", secondary: "#FC4C02" },
      { name: "Minnesota Vikings",    primary: "#4F2683", secondary: "#FFC62F" },
      { name: "New England Patriots", primary: "#002244", secondary: "#C60C30" },
      { name: "New Orleans Saints",   primary: "#101820", secondary: "#D3BC8D" },
      { name: "New York Giants",      primary: "#0B2265", secondary: "#A71930" },
      { name: "New York Jets",        primary: "#125740", secondary: "#FFFFFF" },
      { name: "Philadelphia Eagles",  primary: "#004C54", secondary: "#A5ACAF" },
      { name: "Pittsburgh Steelers",  primary: "#FFB612", secondary: "#101820" },
      { name: "San Francisco 49ers",  primary: "#AA0000", secondary: "#B3995D" },
      { name: "Seattle Seahawks",     primary: "#002244", secondary: "#69BE28" },
      { name: "Tampa Bay Buccaneers", primary: "#D50A0A", secondary: "#FF7900" },
      { name: "Tennessee Titans",     primary: "#0C2340", secondary: "#4B92DB" },
      { name: "Washington Commanders",primary: "#5A1414", secondary: "#FFB612" }
    ];


    // ===== SET CURRENT WEEK HERE (ONLY PLACE TO CHANGE) =====
    const CURRENT_WEEK = 11;
    let gameState = {
      currentWeek: CURRENT_WEEK,
      usedTeams: [],
      selectedTeam: null,
      isActive: true,
      weeklyPicks: [],
      lastWeekAdvancement: 0
    };

    let currentUser = null;
    let currentProfile = null;
    let globalTeamCounts = new Map(); // Store team pick counts globally
    let allPicksData = []; // Store all picks data globally for week navigation
    let currentPickTickerWeek = CURRENT_WEEK - 1; // Track current week in Pick Ticker (one week behind)

    function getCentralNow(){
      const now = new Date();
      return new Date(now.toLocaleString("en-US", { timeZone: "America/Chicago" }));
    }

    // Removed: autoFitPlayerName function no longer needed since playerName element was removed

    // FIXED: Debug version with detailed logging
    async function refreshAuthUI(){
      try {
        const { data: { user } } = await supabase.auth.getUser();
        currentUser = user || null;
        
        // DEBUG: Log current user
        console.log('üîç Current user:', currentUser?.id, currentUser?.email);

        const loggedOutEl = document.getElementById('authWhenLoggedOut');
        const loggedInEl = document.getElementById('authWhenLoggedIn');
        const usernameGateEl = document.getElementById('usernameGate');
        const displayUserEl = document.getElementById('displayUser');
        const submitPickEl = document.getElementById('submitPick');
        const statusBarEl = document.getElementById('statusBar');

        if(!currentUser){
          loggedOutEl.style.display = 'flex';
          loggedInEl.style.display = 'none';
          usernameGateEl.style.display = 'none';
          displayUserEl.textContent = '';
          if (statusBarEl) statusBarEl.style.display = 'none';

          if (submitPickEl) {
            submitPickEl.disabled = true;
          }
          // Removed: playerName element no longer exists
          updateStatus();
          return;
        }

        loggedOutEl.style.display = 'none';
        loggedInEl.style.display = 'flex';
        if (statusBarEl) statusBarEl.style.display = 'grid';

        // DEBUG: Log the profile fetch attempt
        console.log('üîç Fetching profile for user ID:', currentUser.id);
        
        const { data: profile, error } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', currentUser.id)
          .maybeSingle();

        // DEBUG: Log the results
        console.log('üîç Profile fetch result:', { profile, error });
        
        if(error && error.code !== 'PGRST116') {
          console.error('‚ùå Profile fetch error:', error);
          // Show more details about the error
          alert(`Profile fetch error: ${error.message} (Code: ${error.code})`);
          return;
        }

        if(!profile){
          console.log('‚ö†Ô∏è No profile found, showing username gate');
          usernameGateEl.style.display = 'block';
          usernameGateEl.setAttribute('aria-hidden', 'false');
          currentProfile = null;
          displayUserEl.textContent = '(set username)';
          // Removed: playerName element no longer exists
          updateStatus();
        }else{
          console.log('‚úÖ Profile found:', profile.username);
          usernameGateEl.style.display = 'none';
          usernameGateEl.setAttribute('aria-hidden', 'true');
          currentProfile = profile;
          displayUserEl.textContent = '@' + profile.username;
          // Removed: playerName element no longer exists

          await loadUserPicksAndDisableTeams();
        }
      } catch(error) {
        console.error('‚ùå Auth refresh error:', error);
        alert(`Auth refresh error: ${error.message}`);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const btnSignInEl = document.getElementById('btnSignIn');
      const btnSignOutEl = document.getElementById('btnSignOut');
      const btnResetPasswordEl = document.getElementById('btnResetPassword');
      const btnSaveUsernameEl = document.getElementById('btnSaveUsername');
      const submitPickEl = document.getElementById('submitPick');

      if (btnSignInEl) {
        btnSignInEl.addEventListener('click', async () => {
          const email = document.getElementById('authEmail').value.trim();
          const password = document.getElementById('authPass').value;
          
          if(!email || !password) {
            alert('Please enter both email and password.');
            return;
          }

          try {
            const { data, error } = await supabase.auth.signInWithPassword({ 
              email, 
              password 
            });
            
            if(error) {
              alert('Sign in error: ' + error.message);
            } else {
              console.log('‚úÖ Sign in successful');
              await refreshAuthUI();
            }
          } catch(error) {
            console.error('Signin error:', error);
            alert('An unexpected error occurred during sign in.');
          }
        });
      }

      if (btnResetPasswordEl) {
        btnResetPasswordEl.addEventListener('click', async () => {
          const email = document.getElementById('authEmail').value.trim();
          
          if(!email) {
            alert('Please enter your email address first.');
            return;
          }

          try {
            const { error } = await supabase.auth.resetPasswordForEmail(email, {
              redirectTo: 'https://the-game-bureau.github.io/ff/reset.html',
            });
            
            if(error) {
              alert('Password reset error: ' + error.message);
            } else {
              alert('Password reset email sent! Check your inbox and follow the instructions.');
            }
          } catch(error) {
            console.error('Password reset error:', error);
            alert('An unexpected error occurred during password reset.');
          }
        });
      }

      if (btnSignOutEl) {
        btnSignOutEl.addEventListener('click', async () => {
          try {
            await supabase.auth.signOut();
            gameState.selectedTeam = null;
            await refreshAuthUI();
            renderTeams();
            updateStatus();
          } catch(error) {
            console.error('Signout error:', error);
          }
        });
      }

      if (btnSaveUsernameEl) {
        btnSaveUsernameEl.addEventListener('click', async () => {
          const username = document.getElementById('usernameInput').value.trim();
          const errorEl = document.getElementById('usernameError');
          
          errorEl.textContent = '';

          if(!username || !/^[a-zA-Z0-9_]{3,20}$/.test(username)){
            errorEl.textContent = 'Your publicly visible username must be 3‚Äì20 characters, letters/numbers/underscore only.';
            return;
          }

          const email = currentUser?.email || null;

          try {
            const { error } = await supabase
              .from('profiles')
              .insert({ 
                id: currentUser.id, 
                username: username, 
                email: email 
              });

            if(error){
              if(error.code === '23505') {
                errorEl.textContent = 'That username is already taken.';
              } else {
                errorEl.textContent = 'Error creating profile: ' + error.message;
              }
              return;
            }

            document.getElementById('usernameGate').style.display = 'none';
            document.getElementById('usernameGate').setAttribute('aria-hidden', 'true');
            await refreshAuthUI();
            
          } catch(error) {
            console.error('Username save error:', error);
            errorEl.textContent = 'An unexpected error occurred.';
          }
        });
      }

      if (submitPickEl) {
        submitPickEl.addEventListener('click', submitPick);
      }

      // Floating Schedule Controls
      const toggleScheduleBtn = document.getElementById('toggleScheduleBtn');
      const closeScheduleBtn = document.getElementById('closeScheduleBtn');
      const floatingScheduleContainer = document.getElementById('floatingScheduleContainer');
      const scheduleIframe = document.getElementById('scheduleIframe');
      const scheduleTitle = document.getElementById('scheduleTitle');

      function getScheduleUrl() {
        const week = gameState.currentWeek;
        return `https://plaintextsports.com/nfl/2025/week${week}`;
      }

      function openFloatingSchedule() {
        const url = getScheduleUrl();
        scheduleIframe.src = url;
        scheduleTitle.textContent = `NFL Week ${gameState.currentWeek} Schedule`;
        floatingScheduleContainer.classList.add('visible');
        toggleScheduleBtn.classList.add('hidden');
      }

      function closeFloatingSchedule() {
        floatingScheduleContainer.classList.remove('visible');
        toggleScheduleBtn.classList.remove('hidden');
        // Optional: clear iframe to save resources
        // scheduleIframe.src = '';
      }

      if (toggleScheduleBtn) {
        toggleScheduleBtn.addEventListener('click', openFloatingSchedule);
      }

      if (closeScheduleBtn) {
        closeScheduleBtn.addEventListener('click', closeFloatingSchedule);
      }

      // Floating Pick Ticker Controls
      const togglePickTickerBtn = document.getElementById('togglePickTickerBtn');
      const closePickTickerBtn = document.getElementById('closePickTickerBtn');
      const floatingPickTickerContainer = document.getElementById('floatingPickTickerContainer');
      const prevPickWeekBtn = document.getElementById('prevPickWeekBtn');
      const nextPickWeekBtn = document.getElementById('nextPickWeekBtn');
      const pickTickerTitle = document.getElementById('pickTickerTitle');

      function renderPickTickerForWeek(week) {
        const floatingPicksBody = document.getElementById('floatingPicksBody');

        // Filter picks for the selected week
        const weekPicks = allPicksData.filter(pick => pick.week === week);

        // Sort by created_at descending (newest first)
        weekPicks.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

        // Update title
        pickTickerTitle.textContent = `Pick Ticker Week ${week}`;

        // Render picks
        const pickRows = weekPicks.map(pick => {
          const createdAt = new Date(pick.created_at);
          const timestamp = isNaN(createdAt.getTime()) ?
            'Invalid Date' :
            createdAt.toLocaleString('en-US', {
              timeZone: 'America/Chicago',
              month: 'short',
              day: 'numeric',
              hour: 'numeric',
              minute: '2-digit'
            });

          return `
            <tr>
              <td>@${pick.username || '(unknown)'}</td>
              <td>${pick.team}</td>
              <td style="color:var(--text-secondary);font-size:0.875rem;">${timestamp}</td>
            </tr>
          `;
        }).join('');

        floatingPicksBody.innerHTML = pickRows ||
          `<tr><td colspan="3" style="color:var(--text-tertiary);text-align:center;padding:24px;">No picks for Week ${week} yet.</td></tr>`;

        // Update navigation buttons state
        const minWeek = 1;
        const maxWeek = Math.max(...allPicksData.map(p => p.week), gameState.currentWeek);

        prevPickWeekBtn.disabled = week <= minWeek;
        nextPickWeekBtn.disabled = week >= maxWeek;
      }

      function openFloatingPickTicker() {
        // Set to current week by default
        currentPickTickerWeek = gameState.currentWeek;
        renderPickTickerForWeek(currentPickTickerWeek);
        floatingPickTickerContainer.classList.add('visible');
        togglePickTickerBtn.classList.add('hidden');
      }

      function closeFloatingPickTicker() {
        floatingPickTickerContainer.classList.remove('visible');
        togglePickTickerBtn.classList.remove('hidden');
      }

      if (togglePickTickerBtn) {
        togglePickTickerBtn.addEventListener('click', openFloatingPickTicker);
      }

      if (closePickTickerBtn) {
        closePickTickerBtn.addEventListener('click', closeFloatingPickTicker);
      }

      if (prevPickWeekBtn) {
        prevPickWeekBtn.addEventListener('click', () => {
          if (currentPickTickerWeek > 1) {
            currentPickTickerWeek--;
            renderPickTickerForWeek(currentPickTickerWeek);
          }
        });
      }

      if (nextPickWeekBtn) {
        nextPickWeekBtn.addEventListener('click', () => {
          const maxWeek = Math.max(...allPicksData.map(p => p.week), gameState.currentWeek);
          if (currentPickTickerWeek < maxWeek) {
            currentPickTickerWeek++;
            renderPickTickerForWeek(currentPickTickerWeek);
          }
        });
      }

      // Close on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && floatingScheduleContainer.classList.contains('visible')) {
          closeFloatingSchedule();
        }
        if (e.key === 'Escape' && floatingPickTickerContainer.classList.contains('visible')) {
          closeFloatingPickTicker();
        }
      });

      // Removed: window resize listener for autoFitPlayerName no longer needed

      document.addEventListener('keydown', (e) => {
        if(e.key === 'Escape') {
          const usernameGate = document.getElementById('usernameGate');
          if(usernameGate.style.display === 'block') {
            usernameGate.style.display = 'none';
            usernameGate.setAttribute('aria-hidden', 'true');
          }
        }
        
        if(e.target.id === 'usernameInput' && e.key === 'Enter') {
          if (btnSaveUsernameEl) {
            btnSaveUsernameEl.click();
          }
        }
        
        if((e.target.id === 'authEmail' || e.target.id === 'authPass') && e.key === 'Enter') {
          if (btnSignInEl) {
            btnSignInEl.click();
          }
        }
      });

      // Modified initialization
      (async function initializeApplication(){
        console.log('Law & Order: Special Victory Unit - Initializing...');
        
        try {
          renderTeams();
          updateStatus();

          await refreshAuthUI();
          await refreshLeagueStats();
          
          console.log(`Application initialized successfully - Week ${gameState.currentWeek}`);
          
        } catch(error) {
          console.error('Application initialization failed:', error);
        }
      })();
    });

    // FIXED: Added debouncing to prevent rapid auth state cycling
    let authRefreshTimeout;

    supabase.auth.onAuthStateChange((event, session) => {
      console.log('Auth state changed:', event);
      
      // Clear any pending refresh
      clearTimeout(authRefreshTimeout);
      
      // Debounce the refresh to avoid rapid cycles
      authRefreshTimeout = setTimeout(() => {
        refreshAuthUI();
      }, 500);
    });

    async function loadUserPicksAndDisableTeams(){
      if(!currentUser) return;

      try {
        const { data: picks, error } = await supabase
          .from('picks')
          .select('week, team, result')
          .eq('user_id', currentUser.id)
          .order('week', { ascending: true });

        if(error) {
          console.error('Error loading picks:', error);
          return;
        }

        gameState.usedTeams = picks.map(p => p.team);
        gameState.weeklyPicks = picks.slice();

        // Find the latest pick's status
        const latestPick = picks.length > 0 ? picks[picks.length - 1] : null;
        const playerStatusEl = document.getElementById('playerStatus');
        const playerStatusCardEl = document.getElementById('playerStatusCard');

        if (latestPick && latestPick.result && playerStatusEl && playerStatusCardEl) {
          const status = latestPick.result;
          const statusLower = status.toLowerCase();

          // Remove all status classes
          playerStatusCardEl.classList.remove('status-survived', 'status-dun-dun', 'status-pick-is-in');

          // Add appropriate class and display text
          if (statusLower.includes('survived')) {
            playerStatusCardEl.classList.add('status-survived');
            playerStatusEl.textContent = 'SURVIVED';
          } else if (statusLower.includes('dun dun')) {
            playerStatusCardEl.classList.add('status-dun-dun');
            playerStatusEl.textContent = 'DUN DUN';
          } else if (statusLower.includes('pick is in')) {
            playerStatusCardEl.classList.add('status-pick-is-in');
            playerStatusEl.textContent = 'PICK IS IN';
          } else {
            playerStatusEl.textContent = status;
          }
        } else if (playerStatusEl) {
          playerStatusEl.textContent = '-';
          if (playerStatusCardEl) {
            playerStatusCardEl.classList.remove('status-survived', 'status-dun-dun', 'status-pick-is-in');
          }
        }

        const currentWeekPick = picks.find(p => p.week === gameState.currentWeek);
        const alreadyPickedEl = document.getElementById('alreadyPickedMsg');
        const submitPickEl = document.getElementById('submitPick');

        if(currentWeekPick && alreadyPickedEl && submitPickEl) {
          submitPickEl.disabled = true;
          alreadyPickedEl.style.display = 'none';
        } else {
          if (alreadyPickedEl) alreadyPickedEl.style.display = 'none';
        }

        renderTeams();
        updateStatus();

      } catch(error) {
        console.error('Unexpected error loading picks:', error);
      }
    }

    async function submitPick(){
      if(!currentUser) {
        alert('Please sign in first, detective.');
        return;
      }
      
      if(!currentProfile) {
        alert('Please choose a username to play.');
        return;
      }
      
      if(!gameState.selectedTeam || !gameState.isActive) {
        return;
      }

      const week = gameState.currentWeek;
      const team = gameState.selectedTeam;

      try {
        const { error } = await supabase
          .from('picks')
          .insert({
            user_id: currentUser.id,
            week: week,
            team: team,
            username: currentProfile.username
          });

        if(error) {
          if(error.code === '23505') {
            alert('Freeze!: Either you already picked this week, or you already picked that team. Contact KK to change your pick');
          } else {
            alert('Error submitting pick: ' + error.message);
          }
          return;
        }

        gameState.weeklyPicks.push({ week, team });
        const submitPickEl = document.getElementById('submitPick');
        if (submitPickEl) {
          submitPickEl.disabled = true;
        }

        const verdictEl = document.createElement('div');
        verdictEl.className = 'verdict slide-in';
        verdictEl.innerHTML = `<strong>DA McCoy:</strong> "The people have selected ${team} to lose in Week ${week}. Let's see if justice prevails."`;
        document.getElementById('teamSelection').appendChild(verdictEl);
        
        setTimeout(() => {
          if(verdictEl.parentNode) {
            verdictEl.remove();
          }
        }, 4500);

        await loadUserPicksAndDisableTeams();
        await refreshLeagueStats();

      } catch(error) {
        console.error('Unexpected error submitting pick:', error);
        alert('An unexpected error occurred while submitting your pick.');
      }
    }


    function renderTeams(){
      const teamGridEl = document.getElementById('teamGrid');
      teamGridEl.innerHTML = '';

      nflTeams.forEach((team) => {
        const isUsed = gameState.usedTeams.includes(team.name);
        const isSelected = gameState.selectedTeam === team.name;

        // Find the week this team was picked
        let pickedWeek = null;
        if (isUsed) {
          const pick = gameState.weeklyPicks.find(p => p.team === team.name);
          if (pick) pickedWeek = pick.week;
        }

        const cardEl = document.createElement('div');
        cardEl.className = 'team-card';
        cardEl.setAttribute('role', 'button');
        cardEl.setAttribute('tabindex', isUsed || !gameState.isActive ? '-1' : '0');
        cardEl.setAttribute('aria-pressed', isSelected ? 'true' : 'false');
        cardEl.setAttribute('aria-label', `Pick ${team.name}${isUsed ? ' (already used)' : ''}`);

        const teamPrimary = team.primary || '#4B5563';
        const teamSecondary = team.secondary || '#E5E7EB';

        // Unpicked teams: team colors with white text
        // Picked teams: gray background with normal text
        if (isUsed) {
          cardEl.style.background = 'var(--bg-primary)';
          cardEl.style.color = 'var(--text-primary)';
          cardEl.style.borderLeftColor = teamPrimary;
        } else {
          cardEl.style.background = teamPrimary;
          cardEl.style.color = 'white';
          cardEl.style.borderLeftColor = teamPrimary;
          cardEl.style.borderColor = teamSecondary;
          cardEl.style.textShadow = '1px 1px 2px rgba(0, 0, 0, 0.5)';
        }
        cardEl.style.setProperty('--team-primary', teamPrimary);
        cardEl.style.setProperty('--team-secondary', teamSecondary);

        // Get total picks for this team from global counts
        const totalPicks = globalTeamCounts.get(team.name) || 0;

        cardEl.innerHTML = `
          <div class="team-name">
            ${team.name}
            <br><span style="font-size:0.8rem;margin-top:4px;opacity:0.8">${isUsed && pickedWeek ? `PICKED BY YOU WK${pickedWeek}` : 'AVAILABLE'}</span>
            <br><span style="font-size:0.75rem;margin-top:4px;opacity:0.7">Picked by League ${totalPicks} ${totalPicks === 1 ? 'Time' : 'Times'}</span>
          </div>
        `;

        if(isUsed || !gameState.isActive) {
          cardEl.classList.add('disabled');
          cardEl.setAttribute('aria-disabled', 'true');
        } else {
          cardEl.addEventListener('click', () => selectTeam(team.name));
          cardEl.addEventListener('keydown', (e) => {
            if(e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              selectTeam(team.name);
            }
          });
        }

        if(isSelected && !isUsed) {
          cardEl.classList.add('selected');
        }

        teamGridEl.appendChild(cardEl);
      });
    }

    function selectTeam(teamName){
      if(gameState.usedTeams.includes(teamName) || !gameState.isActive) {
        return;
      }

      gameState.selectedTeam = teamName;
      renderTeams();
      const submitPickEl = document.getElementById('submitPick');
      if (submitPickEl) {
        submitPickEl.disabled = false;
      }
      
      const announcement = `Picked ${teamName}`;
      const ariaLiveEl = document.createElement('div');
      ariaLiveEl.setAttribute('aria-live', 'polite');
      ariaLiveEl.className = 'sr-only';
      ariaLiveEl.textContent = announcement;
      document.body.appendChild(ariaLiveEl);
      setTimeout(() => ariaLiveEl.remove(), 1000);
    }

    function updateStatus(){
      document.getElementById('currentWeek').textContent = gameState.currentWeek;
      document.getElementById('teamsUsedCount').textContent = gameState.usedTeams.length;
      document.getElementById('teamsRemaining').textContent = 32 - gameState.usedTeams.length;

      // Update team selection subtitle with current week
      const subtitleEl = document.getElementById('teamSelectionSubtitle');
      if (subtitleEl) {
        subtitleEl.textContent = `(Pick a team you believe will lose in week ${gameState.currentWeek}):`;
      }

      // Removed: playerName element no longer exists
    }


    function showGameOver(won = false, customMessage = null){
      const gameOverEl = document.getElementById('gameOverSection');
      const messageEl = document.getElementById('gameOverMessage');
      const verdictEl = document.getElementById('finalVerdict');

      if(won) {
        messageEl.textContent = customMessage || 
          `Congratulations! You navigated all 32 teams and made it through ${gameState.currentWeek - 1} weeks!`;
        verdictEl.innerHTML = 
          `<strong>Judge:</strong> "This court finds you NOT GUILTY of poor judgment. Case dismissed with honors!"`;
        verdictEl.style.borderLeftColor = 'var(--success)';
      } else {
        const failedTeam = gameState.selectedTeam || 'Unknown Team';
        messageEl.textContent = customMessage || 
          `Case closed! ${failedTeam} won in Week ${gameState.currentWeek}.`;
        verdictEl.innerHTML = 
          `<strong>Judge:</strong> "The defendant ${failedTeam} has been found NOT GUILTY of losing. Your prosecution has failed. Court adjourned."`;
        verdictEl.style.borderLeftColor = 'var(--error)';
      }

      gameOverEl.style.display = 'block';
      document.getElementById('teamSelection').style.display = 'none';
      
      gameOverEl.focus();
    }

  async function fetchAllPicksPublic() {
    try {
      const { data, error } = await supabase
        .from('picks')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Error fetching league picks:', error);
        return [];
      }
      return data || [];
    } catch (error) {
      console.error('Unexpected error fetching league data:', error);
      return [];
    }
  }
  
  function renderLeagueStats(picks) {
    const users = new Map();
    const teamCounts = new Map();
    const statusCounts = new Map();

    for (const pick of picks) {
      const username = pick.username || '(unknown)';

      if (!users.has(username)) {
        users.set(username, { 
          weeks: new Set(), 
          teams: new Set(), 
          lastWeek: 0,
          allPicks: [],
          status: '',
          latestPickedAt: null
        });
      }

      const userRecord = users.get(username);
      userRecord.weeks.add(pick.week);
      userRecord.teams.add(pick.team);
      userRecord.allPicks.push(pick);
      
      // Track the latest pick timestamp
      const pickDate = new Date(pick.created_at);
      if (!userRecord.latestPickedAt || pickDate > userRecord.latestPickedAt) {
        userRecord.latestPickedAt = pickDate;
      }
      
      if (pick.week > userRecord.lastWeek) {
        userRecord.lastWeek = pick.week;
        userRecord.status = pick.result || '';
      }

      teamCounts.set(pick.team, (teamCounts.get(pick.team) || 0) + 1);
    }

    for (const [username, record] of users.entries()) {
      const status = record.status || 'No Status';
      // Normalize "DUN DUN" statuses to a single category
      const normalizedStatus = status.toLowerCase().includes('dun dun') ? 'DUN DUN' : status;
      statusCounts.set(normalizedStatus, (statusCounts.get(normalizedStatus) || 0) + 1);
    }

    const totalPicks = picks.length;
    const totalPlayers = users.size;

    // Initialize all NFL teams with 0 picks
    const allTeamCounts = new Map();
    nflTeams.forEach(team => {
      allTeamCounts.set(team.name, teamCounts.get(team.name) || 0);
    });

    // Store in global variable for use in renderTeams
    globalTeamCounts = allTeamCounts;

    const allTeamsText = [...allTeamCounts.entries()]
      .sort((a, b) => b[1] - a[1])
      .map(([team, count]) => `${team} (${count})`)
      .join(' ¬∑ ');

    const statusCountsText = [...statusCounts.entries()]
      .sort((a, b) => b[1] - a[1])
      .map(([status, count]) => `${status} (${count})`)
      .join(' ¬∑ ');

    const summaryEl = document.getElementById('statsSummary');
    summaryEl.textContent = `Prosecutors: ${totalPlayers} ¬∑ Picks by League: ${totalPicks}` +
      (statusCountsText ? ` ¬∑ Status: ${statusCountsText}` : '');

    const userTableBody = document.getElementById('userSummaryBody');
    const userRows = [...users.entries()]
      .sort((a, b) => {
        // First sort by weeks picked (descending)
        const weeksA = a[1].weeks.size;
        const weeksB = b[1].weeks.size;
        if (weeksA !== weeksB) {
          return weeksB - weeksA;
        }

        // Then sort by status (descending)
        const statusA = a[1].status || '';
        const statusB = b[1].status || '';
        if (statusA !== statusB) {
          return statusB.localeCompare(statusA);
        }

        // Finally sort by username (ascending)
        return a[0].localeCompare(b[0]);
      })
      .map(([username, record]) => {
        const weeksPicked = record.weeks.size;
        const teamsUsed = record.teams.size;
        const lastWeek = record.lastWeek || 0;
        const status = record.status;

        let statusDisplay = '';
        let statusCellClass = '';

        if (status) {
          const statusLower = status.toLowerCase();

          if (statusLower.includes('survived')) {
            statusCellClass = 'status-survived';
            statusDisplay = status;
          } else if (statusLower.includes('dun dun')) {
            statusCellClass = 'status-dun-dun';
            statusDisplay = status;
          } else if (statusLower.includes('pick is in')) {
            statusCellClass = 'status-pick-is-in';
            statusDisplay = status;
          } else {
            statusDisplay = `<span class="status-label status-other">${status}</span>`;
          }
        }

        // Format the week display based on current week and status
        let weekDisplay = '-';
        if (lastWeek > 0) {
          const isEliminated = status && status.toLowerCase().includes('dun dun');
          const isSurvived = status && status.toLowerCase().includes('survived');
          const isPickIsIn = status && status.toLowerCase().includes('pick is in');
          const isCurrent = lastWeek === gameState.currentWeek;
          const isBehind = lastWeek < gameState.currentWeek;

          if (isEliminated || isSurvived || isPickIsIn) {
            weekDisplay = `Week ${lastWeek}`;
          } else if (isCurrent) {
            weekDisplay = `${lastWeek} (Current)`;
          } else if (isBehind) {
            weekDisplay = `${lastWeek} (${lastWeek} of ${gameState.currentWeek})`;
          } else {
            weekDisplay = `${lastWeek}`;
          }
        }

        return `
          <tr>
            <td>${weekDisplay}</td>
            <td><strong>@${username}</strong></td>
            <td class="${statusCellClass}">${statusDisplay}</td>
          </tr>
        `;
      }).join('');

    userTableBody.innerHTML = userRows ||
      `<tr><td colspan="3" style="color:var(--text-tertiary);text-align:center;padding:24px;">No picks yet.</td></tr>`;
  }

  function renderEliminationChart(picks) {
    const chartContainer = document.getElementById('chartContainer');

    // Count eliminations by week
    const eliminationsByWeek = new Map();
    const users = new Map();

    for (const pick of picks) {
      const username = pick.username || '(unknown)';

      if (!users.has(username)) {
        users.set(username, { lastWeek: 0, status: '' });
      }

      const userRecord = users.get(username);
      if (pick.week > userRecord.lastWeek) {
        userRecord.lastWeek = pick.week;
        userRecord.status = (pick.result || '').toLowerCase();
      }
    }

    // Count how many users were eliminated each week and how many have "Pick Is In"
    let pickIsInCount = 0;
    let pickIsInWeek = 0;
    for (const [username, record] of users.entries()) {
      if (record.status.includes('dun dun')) {
        const week = record.lastWeek;
        eliminationsByWeek.set(week, (eliminationsByWeek.get(week) || 0) + 1);
      }
      if (record.status.includes('pick is in')) {
        pickIsInCount++;
        pickIsInWeek = record.lastWeek; // Track the week
      }
    }

    // Calculate cumulative eliminations and survivors
    const maxWeek = Math.max(...Array.from(eliminationsByWeek.keys()), gameState.currentWeek);
    const weekData = [];
    let cumulativeEliminated = 0;

    // Only show weeks before current week
    const lastWeekToShow = gameState.currentWeek - 1;

    for (let week = 1; week <= lastWeekToShow; week++) {
      cumulativeEliminated += eliminationsByWeek.get(week) || 0;
      weekData.push({ week, eliminated: cumulativeEliminated });
    }

    if (weekData.length === 0) {
      chartContainer.innerHTML = '<p style="color:var(--text-tertiary);text-align:center;padding:24px;">No data yet.</p>';
      return;
    }

    // Get total number of users
    const totalUsers = users.size;
    const maxEliminated = Math.max(...weekData.map(d => d.eliminated), 1);

    let chartHTML = `
      <div style="display:flex;flex-direction:column;gap:12px;max-width:900px;">
        <div style="display:grid;grid-template-columns:70px 110px 1fr 110px;gap:12px;font-size:0.75rem;font-weight:600;color:var(--text-tertiary);text-transform:uppercase;align-items:center;">
          <div>Week</div>
          <div style="text-align:right;">DUN DUN</div>
          <div style="text-align:center;">Prosecutors</div>
          <div style="text-align:left;">Survivors</div>
        </div>
    `;

    weekData.forEach(({ week, eliminated }) => {
      const survivors = totalUsers - eliminated;
      const eliminatedPercentage = totalUsers > 0 ? (eliminated / totalUsers) * 100 : 0;
      const survivorsPercentage = totalUsers > 0 ? (survivors / totalUsers) * 100 : 0;
      const eliminatedDisplay = totalUsers > 0 ? ((eliminated / totalUsers) * 100).toFixed(1) : '0.0';
      const survivorsDisplay = totalUsers > 0 ? ((survivors / totalUsers) * 100).toFixed(1) : '0.0';

      chartHTML += `
        <div style="display:grid;grid-template-columns:70px 110px 1fr 110px;gap:12px;align-items:center;">
          <div style="font-weight:600;color:var(--primary-blue);">Week ${week}</div>
          <div style="text-align:right;font-weight:700;color:var(--primary-red);font-family:ui-monospace,monospace;">${eliminated} (${eliminatedDisplay}%)</div>
          <div style="background:var(--bg-secondary);border-radius:4px;overflow:hidden;height:28px;position:relative;display:flex;">
            <div style="background:linear-gradient(90deg, var(--primary-red), var(--primary-red-dark));height:100%;width:${eliminatedPercentage}%;transition:width 0.3s ease;"></div>
            <div style="background:linear-gradient(90deg, var(--success), #047857);height:100%;width:${survivorsPercentage}%;transition:width 0.3s ease;"></div>
          </div>
          <div style="text-align:left;font-weight:700;color:var(--success);font-family:ui-monospace,monospace;">${survivors} (${survivorsDisplay}%)</div>
        </div>
      `;
    });

    chartHTML += '</div>';

    chartContainer.innerHTML = chartHTML;
  }

  async function refreshLeagueStats() {
    const picks = await fetchAllPicksPublic();
    allPicksData = picks; // Store globally for Pick Ticker week navigation
    renderLeagueStats(picks);
    renderEliminationChart(picks);
    // Re-render teams after stats are loaded to show updated pick counts
    renderTeams();
  }
</script>

</body>
</html>